<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏û‡∏±‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏ï‡πá‡∏≠‡∏Å</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- Styles ‡πÄ‡∏î‡∏¥‡∏°‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ --- */
        :root { --primary: #5D4037; --secondary: #8D6E63; --bg: #FDF5E6; --white: #ffffff; --accent: #A1887F; --yellow: #FFA000; --green-soft: #F1F8E9; --orange-soft: #FFF3E0; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #4E342E; }
        .container { max-width: 1100px; margin: 0 auto; }
        .auth-bar { background: rgba(255, 255, 255, 0.9); padding: 15px 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(93, 64, 55, 0.05); }
        .user-info { display: flex; justify-content: space-between; align-items: center; }
        .user-details { display: flex; align-items: center; gap: 15px; }
        .bar-logo { width: 45px; height: auto; border-radius: 8px; }
        .user-img { width: 35px; height: 35px; border-radius: 50%; border: 2px solid var(--secondary); }
        .btn-logout { background: #FFCDD2; color: #C62828; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9em; }
        .tab-menu { display: flex; gap: 8px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: #EFEBE9; border-radius: 10px; cursor: pointer; font-weight: bold; color: var(--secondary); font-size: 1rem; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: var(--white); padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); margin-bottom: 20px; }
        h2 { color: var(--primary); font-size: 1.3em; border-bottom: 1px solid #F5F5F5; padding-bottom: 10px; margin-top: 0; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #D7CCC8; border-radius: 8px; box-sizing: border-box; font-family: 'Sarabun'; margin-bottom: 5px; }
        .action-btn { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #F5F5F5; padding: 12px; text-align: left; font-size: 0.9em; color: var(--secondary); }
        td { padding: 12px; border-bottom: 1px solid #F5F5F5; }
        .total-box { background: #FFF3E0; padding: 25px; border-radius: 12px; margin-top: 15px; border: 1px solid #FFE0B2; text-align: right; }
        .total-price { font-size: 3.2em; font-weight: bold; color: var(--primary); margin: 10px 0; }
        .unit-cost-info { color: #D84315; font-weight: bold; font-size: 1.3em; border-top: 1px dashed #FFE0B2; padding-top: 10px; margin-top: 10px; }
        .edit-btn { background: #FFF9C4; color: #F57F17; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin-right: 4px; }
        .delete-btn { background: #FFEBEE; color: #C62828; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; }
        .withdraw-btn { background: #E1F5FE; color: #0277BD; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; }
        
        /* --- Login & Dashboard --- */
        #login-section { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 90vh; text-align: center; }
        .login-card { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(93, 64, 55, 0.1); max-width: 400px; width: 100%; }
        .login-btn-google { background: #4285F4; color: white; border: none; padding: 12px 20px; border-radius: 50px; font-size: 1rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; margin-top: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 40px; }
        .menu-card { background: white; padding: 30px; border-radius: 20px; text-align: center; cursor: pointer; transition: 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 2px solid transparent; }
        .menu-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .menu-card i { font-size: 3em; color: var(--primary); margin-bottom: 15px; }

        /* --- POS Styles --- */
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .product-item { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 3px 10px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; position: relative; }
        .product-item:hover { transform: scale(1.02); }
        .product-img { width: 100%; height: 120px; object-fit: cover; background: #eee; }
        .product-info { padding: 10px; text-align: center; }
        .stock-badge { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.6); color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 4px; }
        .out-of-stock { opacity: 0.6; pointer-events: none; filter: grayscale(1); }
        
        .cart-panel { background: white; border-radius: 15px; padding: 20px; height: fit-content; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #eee; padding: 10px 0; }
        .cart-total { font-size: 1.5em; font-weight: bold; color: var(--primary); text-align: right; margin-top: 20px; }

        /* --- Bill / Modal Styles --- */
        .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow-y: auto; }
        .modal-content { background: white; margin: 2% auto; padding: 30px; width: 90%; max-width: 500px; border-radius: 10px; }
        
        /* Legal Bill Format */
        .bill-paper { font-family: 'Sarabun', sans-serif; color: #000; }
        .bill-header-row { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 10px; }
        .bill-logo { width: 60px; height: auto; margin-right: 15px; }
        .bill-title { font-size: 1.2em; font-weight: bold; text-align: right; }
        .bill-info { font-size: 0.8em; line-height: 1.4; }
        .bill-table { width: 100%; font-size: 0.85em; border-collapse: collapse; margin-top: 10px; }
        .bill-table th { border-bottom: 1px solid #000; background: #fff; color: #000; text-align: right; padding: 5px; }
        .bill-table th:first-child { text-align: left; }
        .bill-table td { border-bottom: 1px dotted #ccc; padding: 5px; text-align: right; }
        .bill-table td:first-child { text-align: left; }
        .bill-summary { margin-top: 15px; text-align: right; font-size: 0.9em; }
        
        @media print {
            body * { visibility: hidden; }
            #printableArea, #printableArea * { visibility: visible; }
            #printableArea { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 20px; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

<div id="login-section">
    <div class="login-card">
        <img src="‡∏û‡∏±‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á.png" style="width: 100px; border-radius: 15px; margin-bottom: 20px;" onerror="this.src='https://via.placeholder.com/100'">
        <h2 style="border:none; color:var(--primary); margin-bottom: 5px;">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô</h2>
        <p style="color:var(--secondary); margin-bottom: 20px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
        <button onclick="loginWithGoogle()" class="login-btn-google"><i class="fab fa-google"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google</button>
    </div>
</div>

<div id="app-section" class="container hidden">
    <div class="auth-bar">
        <div id="userInfo" class="user-info">
            <div class="user-details">
                <img id="userImg" src="" class="user-img">
                <div>
                    <span id="userName" style="font-weight:bold;">User</span>
                    <span id="roleBadge" style="background:#D32F2F; font-size:0.75em; padding:3px 10px; border-radius:12px; margin-left:5px; color:white; font-weight:bold; display:none;">Admin</span>
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="goHome()" class="action-btn" style="background:var(--secondary); font-size:0.9em;"><i class="fas fa-home"></i> ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
                <button onclick="logout()" class="btn-logout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>
    </div>

    <div id="dashboard-view">
        <div style="text-align: center; margin-top: 20px;">
            <h1 style="color: var(--primary);">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö ‡∏û‡∏±‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á</h1>
            <button id="btnShopSettings" onclick="openShopSettings()" class="action-btn hidden" style="background:var(--accent); font-size:0.9em; margin-bottom:20px;"><i class="fas fa-cog"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏¥‡∏•)</button>
        </div>
        <div class="dashboard-grid">
            <div class="menu-card" onclick="openSystem('pos')">
                <i class="fas fa-cash-register"></i>
                <h3>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô (POS)</h3>
                <p>‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤, ‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ, ‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ç‡∏≤‡∏¢</p>
            </div>
            <div class="menu-card" onclick="openSystem('cost')">
                <i class="fas fa-boxes"></i>
                <h3>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö & ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</h3>
                <p>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö, ‡πÄ‡∏ö‡∏¥‡∏Å‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á, ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏π‡∏ï‡∏£</p>
            </div>
        </div>
    </div>

    <div id="pos-view" class="hidden">
        <div class="tab-menu">
            <button class="tab-btn active" onclick="openPosTab('sales')">üõí ‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
            <button class="tab-btn" id="btnManageProduct" onclick="openPosTab('products')">üì¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢ (Admin)</button>
        </div>

        <div id="pos-sales" class="pos-content active">
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                <div>
                    <div id="productGrid" class="product-grid">Loading...</div>
                </div>
                <div class="cart-panel">
                    <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h3>
                    
                    <div style="background:#F9F9F9; padding:10px; border-radius:8px; margin-bottom:15px;">
                        <div style="font-size:0.8em; font-weight:bold; margin-bottom:5px;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•)</div>
                        <input type="text" id="custName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó" style="font-size:0.9em; padding:8px;">
                        <input type="text" id="custTax" placeholder="‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" style="font-size:0.9em; padding:8px;">
                        <input type="text" id="custAddr" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà" style="font-size:0.9em; padding:8px;">
                    </div>

                    <div id="cartItems">
                        <p style="text-align:center; color:#ccc; margin-top:20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
                    </div>
                    <div class="cart-total">‡∏£‡∏ß‡∏°: <span id="cartTotal">0.00</span> ‡∏ö.</div>
                    
                    <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;">
                        <button onclick="processCheckout('bill')" class="action-btn" style="width:100%; background:#2E7D32;"><i class="fas fa-print"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î & ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button>
                        <button onclick="processCheckout('quote')" class="action-btn" style="width:100%; background:#FF9800;"><i class="fas fa-file-invoice"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</button>
                        <button onclick="clearCart()" class="delete-btn" style="width:100%;">‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="pos-products" class="pos-content hidden">
            <div class="card">
                <h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ (Finished Goods)</h2>
                <div style="background:#FFF3E0; padding:10px; border-radius:8px; margin-bottom:10px; font-size:0.9em;">
                    <i class="fas fa-info-circle"></i> <b>‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û:</b> ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏à‡∏≤‡∏Å Google Drive ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á
                </div>
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="prodName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
                    <input type="number" id="prodPrice" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢">
                    <input type="number" id="prodStock" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å">
                    <input type="text" id="prodImg" placeholder="Link ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (Google Drive etc.)">
                </div>
                <button onclick="addProduct()" class="action-btn" style="width:100%; margin-bottom:20px;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                
                <table>
                    <thead><tr><th>‡∏£‡∏π‡∏õ</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th><th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                    <tbody id="productTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="cost-view" class="hidden">
        <div class="tab-menu">
            <button class="tab-btn active" onclick="openTab('calculator')">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</button>
            <button class="tab-btn" onclick="openTab('history')">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</button>
        </div>

        <div id="calculator" class="tab-content active">
            <div class="card">
                <h2>1. ‡∏Ñ‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö (Raw Material Stock)</h2>
                <p style="font-size:0.9em; color:#666;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏¥‡∏Å‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô</p>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 10px; align-items: end; margin-top:15px;">
                    <input type="text" id="stockName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö (‡πÅ‡∏õ‡πâ‡∏á, ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•)">
                    <input type="number" id="stockPrice" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏∏‡∏ô‡∏ã‡∏∑‡πâ‡∏≠‡∏°‡∏≤">
                    <input type="number" id="stockQty" placeholder="‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠">
                    <select id="stockUnit">
                        <option value="" disabled selected>‡∏´‡∏ô‡πà‡∏ß‡∏¢</option>
                        <option value="‡∏Å‡∏£‡∏±‡∏°">‡∏Å‡∏£‡∏±‡∏° (g)</option>
                        <option value="‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°">‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏° (kg)</option>
                        <option value="‡∏°‡∏¥‡∏•‡∏•‡∏¥‡∏•‡∏¥‡∏ï‡∏£">‡∏°‡∏¥‡∏•‡∏•‡∏¥‡∏•‡∏¥‡∏ï‡∏£ (ml)</option>
                        <option value="‡∏•‡∏¥‡∏ï‡∏£">‡∏•‡∏¥‡∏ï‡∏£ (l)</option>
                        <option value="‡∏ä‡∏¥‡πâ‡∏ô">‡∏ä‡∏¥‡πâ‡∏ô</option>
                        <option value="‡∏ü‡∏≠‡∏á">‡∏ü‡∏≠‡∏á</option>
                        <option value="‡∏Å‡∏•‡πà‡∏≠‡∏á">‡∏Å‡∏•‡πà‡∏≠‡∏á</option>
                        <option value="‡∏ñ‡∏∏‡∏á">‡∏ñ‡∏∏‡∏á</option>
                    </select>
                    <button onclick="addStock()" class="action-btn"><i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
                </div>

                <div style="margin-top:20px;">
                    <input type="text" id="searchStockRaw" onkeyup="filterStockRaw()" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö..." style="margin-bottom:10px;">
                    <table>
                        <thead><tr><th>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</th><th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th style="text-align:center;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                        <tbody id="stockTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="history" class="tab-content">
            <div class="card">
                <button onclick="loadHistoryFromFirebase()" class="action-btn"><i class="fas fa-sync"></i> ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <div id="historyList" style="margin-top:10px;"></div>
            </div>
        </div>
    </div>
</div>

<div id="shopSettingsModal" class="modal">
    <div class="modal-content">
        <h2 style="color:var(--primary);">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏¥‡∏•)</h2>
        <input type="text" id="shopName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤">
        <textarea id="shopAddress" rows="3" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤"></textarea>
        <input type="text" id="shopTaxID" placeholder="‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
        <input type="text" id="shopPhone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå">
        <div style="margin-top:20px; display:flex; justify-content:flex-end; gap:10px;">
            <button onclick="saveShopSettings()" class="action-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button onclick="document.getElementById('shopSettingsModal').style.display='none'" class="delete-btn">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>
</div>

<div id="billModal" class="modal">
    <div class="modal-content bill-paper">
        <div id="printableArea">
            <div class="bill-header-row">
                <div style="display:flex; align-items:flex-start;">
                    <img src="‡∏û‡∏±‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á.png" class="bill-logo" id="billLogoImg" onerror="this.style.display='none'"> 
                    <div class="bill-info">
                        <b style="font-size:1.1em;" id="printShopName">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô</b><br>
                        <span id="printShopAddr">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà...</span><br>
                        <span id="printShopTax">‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ: -</span><br>
                        <span id="printShopPhone">‡πÇ‡∏ó‡∏£: -</span>
                    </div>
                </div>
                <div class="bill-title">
                    <span id="docTitle">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</span><br>
                    <span style="font-size:0.6em; font-weight:normal;">(Receipt / Tax Invoice)</span>
                </div>
            </div>

            <div style="display:flex; justify-content:space-between; font-size:0.85em; margin-bottom:10px;">
                <div style="width:55%;">
                    <b>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</b> <span id="printCustName">-</span><br>
                    <b>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</b> <span id="printCustAddr">-</span><br>
                    <b>‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ:</b> <span id="printCustTax">-</span>
                </div>
                <div style="width:40%; text-align:right;">
                    <b>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</b> <span id="printInvNo">INV-XXXX</span><br>
                    <b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</b> <span id="printDate">DD/MM/YYYY</span><br>
                    <b>‡πÄ‡∏ß‡∏•‡∏≤:</b> <span id="printTime">HH:MM</span>
                </div>
            </div>
            
            <table class="bill-table">
                <thead><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th style="width:15%;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th style="width:20%;">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th style="width:20%;">‡∏£‡∏ß‡∏°</th></tr></thead>
                <tbody id="billItems"></tbody>
            </table>
            
            <div class="bill-summary">
                <div style="display:flex; justify-content:flex-end; gap:20px;">
                    <span>‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:</span>
                    <span style="font-weight:bold; font-size:1.2em;" id="billGrandTotal">0.00</span>
                </div>
                <div style="font-size:0.8em; color:#666; margin-top:5px;">(‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß)</div>
            </div>

            <div style="margin-top:30px; display:flex; justify-content:space-between; text-align:center; font-size:0.8em;">
                <div style="width:45%; border-top:1px solid #ccc; padding-top:5px;">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô/‡∏ú‡∏π‡πâ‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•</div>
                <div style="width:45%; border-top:1px solid #ccc; padding-top:5px;">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
            </div>
        </div>
        <div class="no-print" style="margin-top:20px; display:flex; gap:10px; justify-content:center;">
            <button onclick="window.print()" class="action-btn"><i class="fas fa-print"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏¥‡∏•</button>
            <button onclick="closeModal()" class="delete-btn">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>
</div>

<div id="withdrawModal" class="modal">
    <div class="modal-content" style="max-width:300px;">
        <h3>‡πÄ‡∏ö‡∏¥‡∏Å‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h3>
        <p id="withdrawTitle"></p>
        <input type="number" id="withdrawQty" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏õ">
        <input type="hidden" id="withdrawName">
        <input type="hidden" id="withdrawCurrent">
        <div style="margin-top:15px; display:flex; gap:10px;">
            <button onclick="confirmWithdraw()" class="action-btn" style="width:100%;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
            <button onclick="document.getElementById('withdrawModal').style.display='none'" class="delete-btn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, setDoc, updateDoc, increment, query, orderBy, Timestamp, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCzi6OehJGWJwKoaFcYbdIfC7PZrK3er8c",
      authDomain: "pukklong-cost-a10b8.firebaseapp.com",
      projectId: "pukklong-cost-a10b8",
      storageBucket: "pukklong-cost-a10b8.firebasestorage.app",
      messagingSenderId: "274783658577",
      appId: "1:274783658577:web:929415a13be6b580b50e70"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const ADMIN_EMAIL = "pukklong.snackbox@gmail.com";

    let currentUser = null, isAdmin = false;
    window.stockData = []; window.productData = []; window.cart = [];

    // --- Authentication ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            isAdmin = (user.email === ADMIN_EMAIL);
            document.getElementById('userImg').src = user.photoURL;
            document.getElementById('userName').innerText = user.displayName;
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('app-section').classList.remove('hidden');
            
            if(isAdmin) {
                document.getElementById('roleBadge').style.display = 'inline-block';
                document.getElementById('btnManageProduct').style.display = 'block';
                document.getElementById('btnShopSettings').classList.remove('hidden');
            } else {
                document.getElementById('roleBadge').style.display = 'none';
                document.getElementById('btnManageProduct').style.display = 'none';
                document.getElementById('btnShopSettings').classList.add('hidden');
            }
            
            fetchStock();
            fetchProducts();
        } else {
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('app-section').classList.add('hidden');
        }
    });

    window.loginWithGoogle = () => signInWithPopup(auth, provider);
    window.logout = () => signOut(auth).then(() => location.reload());

    // --- Utility: Convert Google Drive Link ---
    function convertDriveLink(url) {
        if (url && url.includes('drive.google.com') && url.includes('/file/d/')) {
            let id = url.split('/file/d/')[1].split('/')[0];
            return `https://drive.google.com/uc?export=view&id=${id}`;
        }
        return url;
    }

    // --- Shop Settings (Admin Only) ---
    window.openShopSettings = async () => {
        if(!isAdmin) return;
        const docRef = doc(db, "settings", "shop_info");
        const docSnap = await getDoc(docRef);
        if(docSnap.exists()) {
            const data = docSnap.data();
            document.getElementById('shopName').value = data.name || '';
            document.getElementById('shopAddress').value = data.address || '';
            document.getElementById('shopTaxID').value = data.taxId || '';
            document.getElementById('shopPhone').value = data.phone || '';
        }
        document.getElementById('shopSettingsModal').style.display = 'block';
    };

    window.saveShopSettings = async () => {
        const info = {
            name: document.getElementById('shopName').value,
            address: document.getElementById('shopAddress').value,
            taxId: document.getElementById('shopTaxID').value,
            phone: document.getElementById('shopPhone').value
        };
        await setDoc(doc(db, "settings", "shop_info"), info);
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß");
        document.getElementById('shopSettingsModal').style.display = 'none';
    };

    // --- POS: Products (Finished Goods) ---
    async function fetchProducts() {
        const snap = await getDocs(collection(db, "products"));
        window.productData = [];
        snap.forEach(d => window.productData.push({id: d.id, ...d.data()}));
        renderProductGrid();
        if(isAdmin) renderProductTable();
    }

    window.addProduct = async () => {
        if(!isAdmin) return alert("Admin Only");
        let name = document.getElementById('prodName').value;
        let price = parseFloat(document.getElementById('prodPrice').value);
        let stock = parseFloat(document.getElementById('prodStock').value);
        let img = convertDriveLink(document.getElementById('prodImg').value);

        if(name && price >= 0) {
            await setDoc(doc(db, "products", name), { name, price, stock, img });
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
            fetchProducts();
            ['prodName','prodPrice','prodStock','prodImg'].forEach(id=>document.getElementById(id).value='');
        }
    };

    window.renderProductGrid = () => {
        let grid = document.getElementById('productGrid');
        grid.innerHTML = '';
        window.productData.forEach(p => {
            let isOut = p.stock <= 0;
            grid.innerHTML += `
                <div class="product-item ${isOut ? 'out-of-stock' : ''}" onclick="addToCart('${p.id}')">
                    <div class="stock-badge">${p.stock} ‡∏ä‡∏¥‡πâ‡∏ô</div>
                    <img src="${p.img || 'https://via.placeholder.com/150'}" class="product-img" onerror="this.src='https://via.placeholder.com/150'">
                    <div class="product-info">
                        <div style="font-weight:bold; font-size:0.9em;">${p.name}</div>
                        <div style="color:var(--primary);">${p.price} ‡∏ö.</div>
                    </div>
                </div>`;
        });
    };

    window.renderProductTable = () => {
        let tb = document.getElementById('productTable');
        tb.innerHTML = '';
        window.productData.forEach(p => {
            tb.innerHTML += `
                <tr>
                    <td><img src="${p.img}" style="width:30px;"></td>
                    <td>${p.name}</td>
                    <td>${p.price}</td>
                    <td>${p.stock}</td>
                    <td><button onclick="deleteProduct('${p.id}')" class="delete-btn">‡∏•‡∏ö</button></td>
                </tr>`;
        });
    };

    window.deleteProduct = async (id) => { if(confirm("‡∏•‡∏ö?")) { await deleteDoc(doc(db, "products", id)); fetchProducts(); }};

    // --- POS: Cart & Checkout ---
    window.addToCart = (id) => {
        let p = window.productData.find(x => x.id === id);
        if(!p || p.stock <= 0) return;
        let exist = window.cart.find(x => x.id === id);
        if(exist) {
            if(exist.qty < p.stock) exist.qty++;
        } else {
            window.cart.push({...p, qty:1});
        }
        renderCart();
    };

    window.renderCart = () => {
        let el = document.getElementById('cartItems'); el.innerHTML = '';
        let total = 0;
        window.cart.forEach((c,i) => {
            total += c.price * c.qty;
            el.innerHTML += `
                <div class="cart-item">
                    <div><b>${c.name}</b> <small>(${c.qty} x ${c.price})</small></div>
                    <div style="display:flex; gap:5px; align-items:center;">
                        <span>${(c.price*c.qty).toFixed(2)}</span>
                        <button onclick="removeFromCart(${i})" class="delete-btn" style="padding:2px 6px;">x</button>
                    </div>
                </div>`;
        });
        document.getElementById('cartTotal').innerText = total.toFixed(2);
    };
    
    window.removeFromCart = (i) => { window.cart.splice(i,1); renderCart(); };
    window.clearCart = () => { window.cart=[]; renderCart(); };

    window.processCheckout = async (type) => {
        if(window.cart.length === 0) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô");
        
        // 1. Prepare Bill Info
        const date = new Date();
        const runNo = "INV-" + date.getFullYear() + (date.getMonth()+1).toString().padStart(2,'0') + date.getDate().toString().padStart(2,'0') + "-" + Math.floor(Math.random()*1000);
        
        // Load Shop Info
        const shopSnap = await getDoc(doc(db, "settings", "shop_info"));
        const shopInfo = shopSnap.exists() ? shopSnap.data() : {name:"‡∏û‡∏±‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á", address:"-", taxId:"-"};

        // Render Modal
        document.getElementById('docTitle').innerText = (type === 'bill') ? "‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ" : "‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤";
        document.getElementById('printShopName').innerText = shopInfo.name;
        document.getElementById('printShopAddr').innerText = shopInfo.address;
        document.getElementById('printShopTax').innerText = "‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ: " + shopInfo.taxId;
        document.getElementById('printShopPhone').innerText = "‡πÇ‡∏ó‡∏£: " + (shopInfo.phone || "-");

        document.getElementById('printCustName').innerText = document.getElementById('custName').value || "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ";
        document.getElementById('printCustAddr').innerText = document.getElementById('custAddr').value || "-";
        document.getElementById('printCustTax').innerText = document.getElementById('custTax').value || "-";
        
        document.getElementById('printInvNo').innerText = (type==='bill') ? runNo : "QT-Temp";
        document.getElementById('printDate').innerText = date.toLocaleDateString('th-TH');
        document.getElementById('printTime').innerText = date.toLocaleTimeString('th-TH');

        let tbody = document.getElementById('billItems'); tbody.innerHTML = '';
        let total = 0;
        window.cart.forEach(c => {
            total += c.qty * c.price;
            tbody.innerHTML += `<tr><td>${c.name}</td><td>${c.qty}</td><td>${c.price.toFixed(2)}</td><td>${(c.qty*c.price).toFixed(2)}</td></tr>`;
        });
        document.getElementById('billGrandTotal').innerText = total.toFixed(2) + " ‡∏ö‡∏≤‡∏ó";
        document.getElementById('billModal').style.display = 'block';

        // 2. Save & Cut Stock (If Bill)
        if(type === 'bill') {
            try {
                await addDoc(collection(db, "sales"), {
                    items: window.cart,
                    total: total,
                    date: Timestamp.now(),
                    invoiceNo: runNo,
                    customer: {
                        name: document.getElementById('custName').value,
                        taxId: document.getElementById('custTax').value
                    }
                });
                
                // Cut Stock
                for(const item of window.cart) {
                    await updateDoc(doc(db, "products", item.id), { stock: increment(-item.qty) });
                }
                
                fetchProducts();
                window.cart = []; renderCart(); // Clear cart after saved
                // Reset inputs
                ['custName','custTax','custAddr'].forEach(id=>document.getElementById(id).value='');
            } catch(e) { alert("Error saving bill: " + e.message); }
        }
    };

    window.closeModal = () => document.getElementById('billModal').style.display = 'none';

    // --- Raw Material Stock (Ingredients) ---
    async function fetchStock() {
        const snap = await getDocs(collection(db, "global_stock"));
        window.stockData = [];
        snap.forEach(d => window.stockData.push(d.data()));
        renderStockTable();
    }

    window.addStock = async () => {
        let n = document.getElementById('stockName').value;
        let p = parseFloat(document.getElementById('stockPrice').value);
        let q = parseFloat(document.getElementById('stockQty').value);
        let u = document.getElementById('stockUnit').value;
        if(n && p && q) {
            // Check existing
            const ref = doc(db, "global_stock", n);
            const snap = await getDoc(ref);
            if(snap.exists()) {
                // Add qty to existing
                let old = snap.data();
                let newQty = parseFloat(old.qty) + q;
                let newPrice = parseFloat(old.price) + p; // Simple accumulation
                await updateDoc(ref, { qty: newQty, price: newPrice, cp: newPrice/newQty });
            } else {
                await setDoc(ref, {name:n, price:p, qty:q, unit:u, cp:p/q});
            }
            fetchStock();
            ['stockName','stockPrice','stockQty','stockUnit'].forEach(id=>document.getElementById(id).value='');
        }
    };

    window.renderStockTable = () => {
        let filter = document.getElementById('searchStockRaw').value.toLowerCase();
        let tb = document.getElementById('stockTable'); tb.innerHTML = '';
        
        window.stockData.forEach((s) => {
            if(!s.name.toLowerCase().includes(filter)) return;
            let delBtn = isAdmin ? `<button onclick="deleteStockRaw('${s.name}')" class="delete-btn"><i class="fas fa-trash"></i></button>` : '';
            tb.innerHTML += `
                <tr>
                    <td><b>${s.name}</b></td>
                    <td style="color:${s.qty < 5 ? 'red' : 'green'};">${parseFloat(s.qty).toFixed(2)} ${s.unit}</td>
                    <td>${s.cp.toFixed(2)}</td>
                    <td style="text-align:center;">
                        <button onclick="openWithdraw('${s.name}', ${s.qty}, '${s.unit}')" class="withdraw-btn">‡πÄ‡∏ö‡∏¥‡∏Å‡πÉ‡∏ä‡πâ</button>
                        ${delBtn}
                    </td>
                </tr>`;
        });
    };
    window.filterStockRaw = renderStockTable;

    // ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö
    window.openWithdraw = (name, qty, unit) => {
        document.getElementById('withdrawTitle').innerHTML = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å: <b>${name}</b><br>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${qty} ${unit}`;
        document.getElementById('withdrawName').value = name;
        document.getElementById('withdrawCurrent').value = qty;
        document.getElementById('withdrawQty').value = '';
        document.getElementById('withdrawModal').style.display = 'block';
    };

    window.confirmWithdraw = async () => {
        let name = document.getElementById('withdrawName').value;
        let current = parseFloat(document.getElementById('withdrawCurrent').value);
        let used = parseFloat(document.getElementById('withdrawQty').value);
        
        if(used > 0) {
            let newQty = current - used;
            await updateDoc(doc(db, "global_stock", name), { qty: newQty });
            alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ ${name} ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${used} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
            document.getElementById('withdrawModal').style.display = 'none';
            fetchStock();
        } else {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ");
        }
    };

    window.deleteStockRaw = async (n) => { if(confirm("‡∏•‡∏ö‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö "+n+"?")) { await deleteDoc(doc(db, "global_stock", n)); fetchStock(); }};

    // Navigation
    window.goHome = () => { document.getElementById('dashboard-view').classList.remove('hidden'); document.getElementById('pos-view').classList.add('hidden'); document.getElementById('cost-view').classList.add('hidden'); };
    window.openSystem = (sys) => {
        document.getElementById('dashboard-view').classList.add('hidden');
        if(sys==='pos') { document.getElementById('pos-view').classList.remove('hidden'); openPosTab('sales'); }
        else { document.getElementById('cost-view').classList.remove('hidden'); openTab('calculator'); }
    };
    window.openPosTab = (t) => {
        document.querySelectorAll('.pos-content').forEach(c=>c.classList.add('hidden'));
        document.querySelectorAll('#pos-view .tab-btn').forEach(b=>b.classList.remove('active'));
        if(t==='sales') { document.getElementById('pos-sales').classList.remove('hidden'); document.querySelectorAll('#pos-view .tab-btn')[0].classList.add('active'); }
        if(t==='products') { if(!isAdmin) return alert("Admin Only"); document.getElementById('pos-products').classList.remove('hidden'); document.querySelectorAll('#pos-view .tab-btn')[1].classList.add('active'); }
    };
    window.openTab = (t) => {
         document.querySelectorAll('#cost-view .tab-content').forEach(c=>c.classList.remove('active'));
         document.querySelectorAll('#cost-view .tab-btn').forEach(b=>b.classList.remove('active'));
         document.getElementById(t).classList.add('active');
         if(event) event.target.classList.add('active');
    };

</script>
</body>
</html>