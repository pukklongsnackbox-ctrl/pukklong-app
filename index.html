<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏û‡∏±‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- Styles Global --- */
        :root { --primary: #5D4037; --secondary: #8D6E63; --bg: #FDF5E6; --white: #ffffff; --accent: #A1887F; --yellow: #FFA000; --green-soft: #F1F8E9; --orange-soft: #FFF3E0; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #4E342E; }
        .container { max-width: 1100px; margin: 0 auto; }
        .auth-bar { background: rgba(255, 255, 255, 0.9); padding: 15px 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(93, 64, 55, 0.05); }
        .user-info { display: flex; justify-content: space-between; align-items: center; }
        .user-details { display: flex; align-items: center; gap: 15px; }
        .user-img { width: 35px; height: 35px; border-radius: 50%; border: 2px solid var(--secondary); }
        .btn-logout { background: #FFCDD2; color: #C62828; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9em; }
        
        .card { background: var(--white); padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); margin-bottom: 20px; }
        h2 { color: var(--primary); font-size: 1.3em; border-bottom: 1px solid #F5F5F5; padding-bottom: 10px; margin-top: 0; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #D7CCC8; border-radius: 8px; box-sizing: border-box; font-family: 'Sarabun'; margin-bottom: 10px; }
        .action-btn { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .action-btn:hover { opacity: 0.9; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #F5F5F5; padding: 12px; text-align: left; font-size: 0.9em; color: var(--secondary); }
        td { padding: 12px; border-bottom: 1px solid #F5F5F5; }
        
        .edit-btn { background: #FFF9C4; color: #F57F17; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin-right: 4px; }
        .delete-btn { background: #FFEBEE; color: #C62828; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; }
        .withdraw-btn { background: #E1F5FE; color: #0277BD; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; }

        /* --- Tabs --- */
        .tab-menu { display: flex; gap: 8px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: #EFEBE9; border-radius: 10px; cursor: pointer; font-weight: bold; color: var(--secondary); font-size: 1rem; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* --- Dashboard --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 30px; }
        .menu-card { background: white; padding: 30px; border-radius: 20px; text-align: center; cursor: pointer; transition: 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 2px solid transparent; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .menu-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .menu-card i { font-size: 3em; color: var(--primary); margin-bottom: 15px; }
        .menu-card h3 { margin: 0; color: #4E342E; }
        .menu-card p { color: #8D6E63; font-size: 0.9em; margin-top: 5px; }

        /* --- POS & Bill --- */
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; }
        .product-item { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 3px 10px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; position: relative; }
        .product-item:hover { transform: scale(1.02); }
        .product-img { width: 100%; height: 110px; object-fit: cover; background: #eee; }
        .product-info { padding: 10px; text-align: center; }
        .stock-badge { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.6); color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 4px; }
        .out-of-stock { opacity: 0.6; pointer-events: none; filter: grayscale(1); }
        
        .cart-panel { background: white; border-radius: 15px; padding: 20px; height: fit-content; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #eee; padding: 10px 0; font-size: 0.9em; }
        
        /* --- Modal & Print --- */
        .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow-y: auto; }
        .modal-content { background: white; margin: 2% auto; padding: 30px; width: 90%; max-width: 500px; border-radius: 10px; }
        
        /* Bill Layout */
        .bill-paper { font-family: 'Sarabun', sans-serif; color: #000; padding: 20px; }
        .bill-header-row { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 10px; margin-bottom: 10px; border-bottom: 1px solid #000; }
        .bill-logo { width: 60px; height: auto; margin-right: 15px; }
        .bill-table-print { width: 100%; font-size: 0.85em; border-collapse: collapse; margin-top: 10px; }
        .bill-table-print th { border-bottom: 1px solid #000; background: #fff; color: #000; text-align: right; padding: 5px; }
        .bill-table-print th:first-child { text-align: left; }
        .bill-table-print td { border-bottom: 1px dotted #ccc; padding: 5px; text-align: right; }
        .bill-table-print td:first-child { text-align: left; }

        @media print {
            body * { visibility: hidden; }
            #printableArea, #printableArea * { visibility: visible; }
            #printableArea { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
            .no-print { display: none !important; }
        }

        /* --- Login --- */
        #login-section { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 90vh; text-align: center; }
        .login-card { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(93, 64, 55, 0.1); max-width: 400px; width: 100%; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="login-section">
    <div class="login-card">
        <img src="‡∏û‡∏±‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á.png" style="width: 100px; border-radius: 15px; margin-bottom: 20px;" onerror="this.src='https://via.placeholder.com/100'">
        <h2 style="border:none; color:var(--primary); margin-bottom: 5px;">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô</h2>
        <button onclick="loginWithGoogle()" class="action-btn" style="background: #4285F4; width:100%; margin-top:20px;"><i class="fab fa-google"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google</button>
    </div>
</div>

<div id="app-section" class="container hidden">
    <div class="auth-bar">
        <div class="user-info">
            <div class="user-details">
                <img id="userImg" src="" class="user-img">
                <div>
                    <span id="userName" style="font-weight:bold;">User</span>
                    <span id="roleBadge" style="background:#D32F2F; font-size:0.75em; padding:2px 8px; border-radius:10px; color:white; display:none;">Admin</span>
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="goHome()" class="action-btn" style="background:var(--secondary); font-size:0.9em;"><i class="fas fa-home"></i> ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
                <button onclick="logout()" class="btn-logout">‡∏≠‡∏≠‡∏Å</button>
            </div>
        </div>
    </div>

    <div id="dashboard-view">
        <div style="text-align: center; margin-top: 10px;">
            <h1 style="color: var(--primary);">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö ‡∏û‡∏±‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á</h1>
            <button id="btnShopSettings" onclick="openShopSettings()" class="action-btn hidden" style="background:var(--accent); font-size:0.9em;"><i class="fas fa-cog"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô (Admin)</button>
        </div>
        <div class="dashboard-grid">
            <div class="menu-card" onclick="openSystem('pos')">
                <i class="fas fa-cash-register"></i>
                <h3>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≤‡∏¢ (POS)</h3>
                <p>‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤, ‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î, ‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ</p>
            </div>
            <div class="menu-card" onclick="openSystem('stock')">
                <i class="fas fa-warehouse"></i>
                <h3>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å (Stock)</h3>
                <p>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö & ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢ (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô)</p>
            </div>
            <div class="menu-card" onclick="openSystem('cost')">
                <i class="fas fa-calculator"></i>
                <h3>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (Cost)</h3>
                <p>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏π‡∏ï‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£, ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å)</p>
            </div>
        </div>
    </div>

    <div id="pos-view" class="hidden">
        <div style="display: grid; grid-template-columns: 2fr 1.2fr; gap: 20px;">
            <div>
                <h2 style="margin-top:0;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                <div id="posProductGrid" class="product-grid">Loading...</div>
            </div>
            
            <div class="cart-panel">
                <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                <div id="cartItems" style="min-height: 150px; max-height: 400px; overflow-y: auto;">
                    <p style="text-align:center; color:#ccc;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
                </div>
                <div style="font-size:1.5em; font-weight:bold; color:var(--primary); text-align:right; margin-top:15px;">
                    ‡∏£‡∏ß‡∏°: <span id="cartTotal">0.00</span> ‡∏ö.
                </div>
                
                <hr style="border:0; border-top:1px dashed #ccc; margin: 15px 0;">
                
                <p style="font-size:0.8em; color:#666; margin-bottom:5px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏¥‡∏•:</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <button onclick="processCheckout('simple')" class="action-btn" style="background:#2E7D32; font-size:0.9em;">
                        <i class="fas fa-receipt"></i> ‡∏ö‡∏¥‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î<br><small>(‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤)</small>
                    </button>
                    <button onclick="processCheckout('full')" class="action-btn" style="background:#1565C0; font-size:0.9em;">
                        <i class="fas fa-file-invoice-dollar"></i> ‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ<br><small>(‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢)</small>
                    </button>
                </div>
                <button onclick="processCheckout('quote')" class="action-btn" style="width:100%; background:#FF9800; margin-bottom:10px;">
                    <i class="fas fa-file-invoice"></i> ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ (‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î‡∏Ç‡∏≠‡∏á)
                </button>
                <button onclick="clearCart()" class="delete-btn" style="width:100%;">‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
            </div>
        </div>
    </div>

    <div id="stock-view" class="hidden">
        <div class="tab-menu">
            <button class="tab-btn active" onclick="openStockTab('raw')">üß± ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö (Raw)</button>
            <button class="tab-btn" onclick="openStockTab('finished')">üéÅ ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢ (Finished)</button>
        </div>

        <div id="stock-raw" class="stock-content active">
            <div class="card">
                <h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h2>
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 5px; align-items: start; margin-bottom:15px;">
                    <input type="text" id="rawName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö (‡πÅ‡∏õ‡πâ‡∏á, ‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•)">
                    <input type="number" id="rawPrice" placeholder="‡∏ó‡∏∏‡∏ô‡∏ã‡∏∑‡πâ‡∏≠">
                    <input type="number" id="rawQty" placeholder="‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì">
                    <input type="text" id="rawUnit" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡∏Å‡∏£‡∏±‡∏°, ‡∏ñ‡∏∏‡∏á)">
                    <button onclick="addRawStock()" class="action-btn">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                </div>
                <input type="text" id="searchRaw" onkeyup="renderRawStock()" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö..." style="margin-bottom:10px;">
                <table>
                    <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</th><th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏ó‡∏∏‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</th><th style="text-align:center;">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                    <tbody id="rawTable"></tbody>
                </table>
            </div>
        </div>

        <div id="stock-finished" class="stock-content hidden">
            <div class="card">
                <h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏≤‡∏¢ (POS)</h2>
                <div id="adminProductForm" class="hidden" style="background:#FFF3E0; padding:15px; border-radius:10px; margin-bottom:15px;">
                    <div style="font-size:0.9em; margin-bottom:10px;"><b>‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</b> (‡πÉ‡∏™‡πà Link Google Drive ‡πÑ‡∏î‡πâ)</div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px;">
                        <input type="text" id="prodName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
                        <input type="number" id="prodPrice" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢">
                        <input type="number" id="prodStock" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å">
                    </div>
                    <input type="text" id="prodImg" placeholder="Link ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û">
                    <button onclick="addProduct()" class="action-btn" style="width:100%;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                </div>
                
                <div id="adminProductWarning" style="color:red; text-align:center; padding:20px;">* ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ *</div>

                <table>
                    <thead><tr><th>‡∏£‡∏π‡∏õ</th><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</th><th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th style="text-align:center;">Admin</th></tr></thead>
                    <tbody id="productTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="cost-view" class="hidden">
        <div class="card">
            <h2>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏™‡∏π‡∏ï‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å)</h2>
            <div style="display: flex; gap: 10px; align-items: flex-end; margin-bottom: 15px;">
                <div style="flex: 2;"><label style="font-size: 0.8em;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</label><select id="selectIngredient"></select></div>
                <div style="flex: 1;"><label style="font-size: 0.8em;">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÉ‡∏ä‡πâ</label><input type="number" id="useQty"></div>
                <button onclick="addToRecipe()" class="action-btn" style="flex: 1;">+ ‡πÉ‡∏™‡πà‡∏™‡∏π‡∏ï‡∏£</button>
            </div>
            <table>
                <thead><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</th><th>‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏ô</th><th>‡∏•‡∏ö</th></tr></thead>
                <tbody id="recipeTable"></tbody>
            </table>
            <div style="background: #FFF3E0; padding: 15px; border-radius: 10px; text-align: right; margin-top: 15px;">
                <div style="font-size:1.5em; font-weight:bold; color:var(--primary);" id="recipeTotal">0.00</div>
                <div style="font-size:0.9em; color:#666;">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏π‡∏ï‡∏£‡∏ô‡∏µ‡πâ</div>
            </div>
        </div>
    </div>
</div>

<div id="shopSettingsModal" class="modal">
    <div class="modal-content">
        <h2>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏¥‡∏•)</h2>
        <input type="text" id="shopName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤">
        <textarea id="shopAddress" rows="3" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤"></textarea>
        <input type="text" id="shopTaxID" placeholder="‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ">
        <input type="text" id="shopPhone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå">
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
            <button onclick="saveShopSettings()" class="action-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button onclick="document.getElementById('shopSettingsModal').style.display='none'" class="delete-btn">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>
</div>

<div id="billModal" class="modal">
    <div class="modal-content bill-paper">
        <div id="customerInputSection" class="no-print" style="margin-bottom:20px; background:#f5f5f5; padding:15px; border-radius:10px;">
            <h3 style="margin-top:0;">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ)</h3>
            <input type="text" id="custName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó">
            <input type="text" id="custAddr" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà">
            <input type="text" id="custTax" placeholder="‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
            <button onclick="refreshBillDisplay()" class="action-btn" style="width:100%; margin-top:5px;">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ö‡∏¥‡∏•</button>
        </div>

        <div id="printableArea">
            <div class="bill-header-row">
                <div style="display:flex;">
                    <img src="‡∏û‡∏±‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á.png" class="bill-logo" onerror="this.style.display='none'">
                    <div style="font-size:0.8em; line-height:1.4;">
                        <b id="printShopName" style="font-size:1.1em;">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô</b><br>
                        <span id="printShopAddr">-</span><br>
                        <span id="printShopPhone">‡πÇ‡∏ó‡∏£: -</span><br>
                        <span id="printShopTax">‡πÄ‡∏•‡∏Ç‡∏†‡∏≤‡∏©‡∏µ: -</span>
                    </div>
                </div>
                <div style="text-align:right;">
                    <b id="billTitle" style="font-size:1.2em;">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</b><br>
                    <span id="billSubtitle" style="font-size:0.7em;">(RECEIPT)</span>
                </div>
            </div>

            <div style="display:flex; justify-content:space-between; font-size:0.8em; margin-bottom:10px;">
                <div style="width:55%;">
                    <b>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</b> <span id="printCustName">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</span><br>
                    <span id="printCustFullDetails" style="display:none;">
                        <b>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</b> <span id="printCustAddr">-</span><br>
                        <b>‡πÄ‡∏•‡∏Ç‡∏†‡∏≤‡∏©‡∏µ:</b> <span id="printCustTax">-</span>
                    </span>
                </div>
                <div style="width:40%; text-align:right;">
                    <b>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</b> <span id="printInvNo">INV-XXX</span><br>
                    <b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</b> <span id="printDate">DD/MM/YYYY HH:MM</span>
                </div>
            </div>

            <table class="bill-table-print">
                <thead><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th style="width:15%;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th style="width:20%;">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏•‡∏∞</th><th style="width:20%;">‡∏£‡∏ß‡∏°</th></tr></thead>
                <tbody id="billBody"></tbody>
            </table>

            <div style="text-align:right; margin-top:15px; font-size:0.9em;">
                ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô: <b style="font-size:1.3em;" id="printTotal">0.00</b> ‡∏ö‡∏≤‡∏ó
                <div style="font-size:0.8em; color:#666;">(‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß)</div>
            </div>
            
            <div style="margin-top:30px; display:flex; justify-content:space-between; text-align:center; font-size:0.7em;">
                <div style="width:40%; border-top:1px solid #ccc; padding-top:5px;">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</div>
                <div style="width:40%; border-top:1px solid #ccc; padding-top:5px;">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
            </div>
        </div>

        <div class="no-print" style="margin-top:20px; display:flex; justify-content:center; gap:10px;">
            <button onclick="confirmAndPrint()" class="action-btn"><i class="fas fa-print"></i> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô & ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
            <button onclick="document.getElementById('billModal').style.display='none'" class="delete-btn">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>
</div>

<div id="withdrawModal" class="modal">
    <div class="modal-content" style="max-width:300px;">
        <h3>‡πÄ‡∏ö‡∏¥‡∏Å‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h3>
        <p id="withdrawTitle"></p>
        <input type="number" id="withdrawAmount" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å">
        <input type="hidden" id="withdrawName">
        <input type="hidden" id="withdrawCurrent">
        <div style="display:flex; gap:10px;">
            <button onclick="confirmWithdraw()" class="action-btn" style="flex:1;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            <button onclick="document.getElementById('withdrawModal').style.display='none'" class="delete-btn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, setDoc, updateDoc, increment, getDoc, Timestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCzi6OehJGWJwKoaFcYbdIfC7PZrK3er8c",
      authDomain: "pukklong-cost-a10b8.firebaseapp.com",
      projectId: "pukklong-cost-a10b8",
      storageBucket: "pukklong-cost-a10b8.firebasestorage.app",
      messagingSenderId: "274783658577",
      appId: "1:274783658577:web:929415a13be6b580b50e70"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const ADMIN_EMAIL = "pukklong.snackbox@gmail.com";

    let currentUser = null, isAdmin = false;
    window.rawStock = []; window.products = []; window.cart = []; window.recipe = [];

    // --- AUTH ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user; isAdmin = (user.email === ADMIN_EMAIL);
            document.getElementById('userImg').src = user.photoURL;
            document.getElementById('userName').innerText = user.displayName;
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('app-section').classList.remove('hidden');
            
            if(isAdmin) {
                document.getElementById('roleBadge').style.display = 'inline-block';
                document.getElementById('btnShopSettings').classList.remove('hidden');
                document.getElementById('adminProductForm').classList.remove('hidden');
                document.getElementById('adminProductWarning').classList.add('hidden');
            }

            fetchRawStock();
            fetchProducts();
        } else {
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('app-section').classList.add('hidden');
        }
    });

    window.loginWithGoogle = () => signInWithPopup(auth, provider);
    window.logout = () => signOut(auth).then(() => location.reload());

    // --- NAVIGATION ---
    window.goHome = () => {
        ['pos-view', 'stock-view', 'cost-view'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById('dashboard-view').classList.remove('hidden');
    };
    window.openSystem = (sys) => {
        document.getElementById('dashboard-view').classList.add('hidden');
        if(sys === 'pos') { document.getElementById('pos-view').classList.remove('hidden'); renderPosGrid(); }
        if(sys === 'stock') { document.getElementById('stock-view').classList.remove('hidden'); openStockTab('raw'); }
        if(sys === 'cost') { document.getElementById('cost-view').classList.remove('hidden'); updateIngredientDropdown(); }
    };
    window.openStockTab = (t) => {
        document.querySelectorAll('.stock-content').forEach(c => c.classList.remove('active')); // hide all
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); // reset buttons
        
        if(t === 'raw') { 
            document.getElementById('stock-raw').classList.add('active');
            document.querySelectorAll('#stock-view .tab-btn')[0].classList.add('active');
        } else { 
            document.getElementById('stock-finished').classList.add('active');
            document.querySelectorAll('#stock-view .tab-btn')[1].classList.add('active');
        }
    };

    // --- 1. STOCK SYSTEM (Raw & Finished) ---
    async function fetchRawStock() {
        const snap = await getDocs(collection(db, "global_stock"));
        window.rawStock = [];
        snap.forEach(d => window.rawStock.push(d.data()));
        renderRawStock();
    }
    
    window.addRawStock = async () => {
        let n = document.getElementById('rawName').value, p = parseFloat(document.getElementById('rawPrice').value), q = parseFloat(document.getElementById('rawQty').value), u = document.getElementById('rawUnit').value;
        if(n && p && q) {
            const ref = doc(db, "global_stock", n);
            const snap = await getDoc(ref);
            if(snap.exists()) {
                let old = snap.data();
                let newQty = parseFloat(old.qty) + q;
                let newPrice = parseFloat(old.price) + p;
                await updateDoc(ref, { qty: newQty, price: newPrice, cp: newPrice/newQty });
            } else {
                await setDoc(ref, {name:n, price:p, qty:q, unit:u, cp:p/q});
            }
            fetchRawStock();
            ['rawName','rawPrice','rawQty','rawUnit'].forEach(id=>document.getElementById(id).value='');
        }
    };

    window.renderRawStock = () => {
        let txt = document.getElementById('searchRaw').value.toLowerCase();
        let tb = document.getElementById('rawTable'); tb.innerHTML = '';
        window.rawStock.forEach(s => {
            if(!s.name.toLowerCase().includes(txt)) return;
            let del = isAdmin ? `<button onclick="deleteRaw('${s.name}')" class="delete-btn">‡∏•‡∏ö</button>` : '';
            tb.innerHTML += `<tr><td>${s.name}</td><td>${parseFloat(s.qty).toFixed(2)} ${s.unit}</td><td>${s.cp.toFixed(2)}</td><td style="text-align:center;"><button onclick="openWithdraw('${s.name}',${s.qty})" class="withdraw-btn">‡πÄ‡∏ö‡∏¥‡∏Å</button> ${del}</td></tr>`;
        });
    };

    window.openWithdraw = (n, q) => {
        document.getElementById('withdrawTitle').innerHTML = `<b>${n}</b> (‡∏°‡∏µ ${q})`;
        document.getElementById('withdrawName').value = n;
        document.getElementById('withdrawCurrent').value = q;
        document.getElementById('withdrawAmount').value = '';
        document.getElementById('withdrawModal').style.display = 'block';
    };

    window.confirmWithdraw = async () => {
        let n = document.getElementById('withdrawName').value, q = parseFloat(document.getElementById('withdrawAmount').value);
        let curr = parseFloat(document.getElementById('withdrawCurrent').value);
        if(q > 0) {
            await updateDoc(doc(db, "global_stock", n), { qty: curr - q });
            document.getElementById('withdrawModal').style.display = 'none';
            fetchRawStock();
        }
    };
    window.deleteRaw = async (n) => { if(confirm('‡∏•‡∏ö?')) { await deleteDoc(doc(db, "global_stock", n)); fetchRawStock(); } };

    // --- Products (Finished Goods) ---
    async function fetchProducts() {
        const snap = await getDocs(collection(db, "products"));
        window.products = [];
        snap.forEach(d => window.products.push({id: d.id, ...d.data()}));
        renderProductTable();
        renderPosGrid();
    }
    
    function convertDriveLink(url) {
        if (url && url.includes('drive.google.com') && url.includes('/file/d/')) {
            let id = url.split('/file/d/')[1].split('/')[0];
            return `https://drive.google.com/uc?export=view&id=${id}`;
        }
        return url;
    }

    window.addProduct = async () => {
        if(!isAdmin) return;
        let n = document.getElementById('prodName').value, p = parseFloat(document.getElementById('prodPrice').value), s = parseFloat(document.getElementById('prodStock').value), i = convertDriveLink(document.getElementById('prodImg').value);
        if(n && p>=0) {
            await setDoc(doc(db, "products", n), { name:n, price:p, stock:s, img:i });
            fetchProducts();
            ['prodName','prodPrice','prodStock','prodImg'].forEach(id=>document.getElementById(id).value='');
        }
    };
    window.deleteProduct = async (id) => { if(confirm('‡∏•‡∏ö?')) { await deleteDoc(doc(db, "products", id)); fetchProducts(); } };
    
    window.renderProductTable = () => {
        let tb = document.getElementById('productTable'); tb.innerHTML = '';
        window.products.forEach(p => {
            tb.innerHTML += `<tr><td><img src="${p.img}" style="width:30px;"></td><td>${p.name}</td><td>${p.price}</td><td>${p.stock}</td><td style="text-align:center;">${isAdmin ? `<button onclick="deleteProduct('${p.id}')" class="delete-btn">‡∏•‡∏ö</button>` : '-'}</td></tr>`;
        });
    };

    // --- 2. POS SYSTEM & BILLING ---
    window.renderPosGrid = () => {
        let g = document.getElementById('posProductGrid'); g.innerHTML = '';
        window.products.forEach(p => {
            let isOut = p.stock <= 0;
            g.innerHTML += `
                <div class="product-item ${isOut?'out-of-stock':''}" onclick="addToCart('${p.id}')">
                    <div class="stock-badge">${p.stock}</div>
                    <img src="${p.img||'https://via.placeholder.com/150'}" class="product-img">
                    <div class="product-info"><b>${p.name}</b><br><span style="color:var(--primary)">${p.price} ‡∏ö.</span></div>
                </div>`;
        });
    };

    window.addToCart = (id) => {
        let p = window.products.find(x => x.id === id);
        if(!p || p.stock <= 0) return;
        let exist = window.cart.find(x => x.id === id);
        if(exist) { if(exist.qty < p.stock) exist.qty++; } else { window.cart.push({...p, qty:1}); }
        renderCart();
    };
    window.renderCart = () => {
        let d = document.getElementById('cartItems'), t = 0; d.innerHTML = '';
        window.cart.forEach((c,i) => {
            t += c.price * c.qty;
            d.innerHTML += `<div class="cart-item"><div>${c.name} x${c.qty}</div><div style="display:flex;gap:5px;"><span>${(c.price*c.qty).toFixed(2)}</span><button onclick="window.cart.splice(${i},1);renderCart()" class="delete-btn" style="padding:0 5px;">x</button></div></div>`;
        });
        document.getElementById('cartTotal').innerText = t.toFixed(2);
    };
    window.clearCart = () => { window.cart = []; renderCart(); };

    // BILL LOGIC
    let currentBillType = 'simple'; // simple, full, quote

    window.processCheckout = async (type) => {
        if(window.cart.length === 0) return alert('‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á');
        currentBillType = type;
        
        // Setup Modal UI based on Type
        const custSection = document.getElementById('customerInputSection');
        const title = document.getElementById('billTitle');
        const sub = document.getElementById('billSubtitle');
        
        if(type === 'simple') {
            custSection.style.display = 'none';
            title.innerText = "‡∏ö‡∏¥‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡πà‡∏≠)";
            sub.innerText = "(CASH BILL)";
        } else if (type === 'full') {
            custSection.style.display = 'block';
            title.innerText = "‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ / ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô";
            sub.innerText = "(TAX INVOICE / RECEIPT)";
        } else {
            custSection.style.display = 'block';
            title.innerText = "‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤";
            sub.innerText = "(QUOTATION)";
        }
        
        await loadShopInfoAndRenderBill();
        document.getElementById('billModal').style.display = 'block';
    };

    async function loadShopInfoAndRenderBill() {
        const date = new Date();
        const runNo = "INV-" + date.getFullYear() + (date.getMonth()+1) + date.getDate() + "-" + Math.floor(Math.random()*1000);
        
        const snap = await getDoc(doc(db, "settings", "shop_info"));
        const s = snap.exists() ? snap.data() : {name:"‡∏û‡∏±‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á", address:"-", taxId:"-"};

        document.getElementById('printShopName').innerText = s.name;
        document.getElementById('printShopAddr').innerText = s.address;
        document.getElementById('printShopTax').innerText = "‡πÄ‡∏•‡∏Ç‡∏†‡∏≤‡∏©‡∏µ: " + s.taxId;
        document.getElementById('printShopPhone').innerText = "‡πÇ‡∏ó‡∏£: " + (s.phone || "-");

        document.getElementById('printInvNo').innerText = currentBillType === 'quote' ? "QT-TEMP" : runNo;
        document.getElementById('printDate').innerText = date.toLocaleString('th-TH');

        window.refreshBillDisplay();
    }

    window.refreshBillDisplay = () => {
        // Customer Details
        if(currentBillType === 'simple') {
            document.getElementById('printCustName').innerText = "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (Cash Sale)";
            document.getElementById('printCustFullDetails').style.display = 'none';
        } else {
            document.getElementById('printCustName').innerText = document.getElementById('custName').value || "-";
            document.getElementById('printCustAddr').innerText = document.getElementById('custAddr').value || "-";
            document.getElementById('printCustTax').innerText = document.getElementById('custTax').value || "-";
            document.getElementById('printCustFullDetails').style.display = 'block';
        }

        // Items
        let tb = document.getElementById('billBody'), t = 0; tb.innerHTML = '';
        window.cart.forEach(c => {
            t += c.price * c.qty;
            tb.innerHTML += `<tr><td>${c.name}</td><td>${c.qty}</td><td>${c.price.toFixed(2)}</td><td>${(c.price*c.qty).toFixed(2)}</td></tr>`;
        });
        document.getElementById('printTotal').innerText = t.toFixed(2);
    };

    window.confirmAndPrint = async () => {
        window.print();
        
        // Save & Deduct Stock (Unless Quote)
        if(currentBillType !== 'quote') {
            try {
                await addDoc(collection(db, "sales"), {
                    items: window.cart,
                    total: parseFloat(document.getElementById('printTotal').innerText),
                    type: currentBillType,
                    date: Timestamp.now(),
                    customer: currentBillType === 'full' ? {
                        name: document.getElementById('custName').value,
                        taxId: document.getElementById('custTax').value
                    } : 'Cash'
                });

                // Deduct Stock
                for(const item of window.cart) {
                    await updateDoc(doc(db, "products", item.id), { stock: increment(-item.qty) });
                }
                
                // Clear & Close
                window.cart = []; renderCart(); fetchProducts();
                setTimeout(() => { document.getElementById('billModal').style.display = 'none'; }, 1000);
            } catch(e) { alert("Error saving: " + e.message); }
        }
    };

    // --- 3. COST CALCULATOR (Pure Logic) ---
    window.updateIngredientDropdown = () => {
        let s = document.getElementById('selectIngredient'); s.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö --</option>';
        window.rawStock.forEach((r, i) => {
            s.innerHTML += `<option value="${i}">${r.name} (‡∏ó‡∏∏‡∏ô: ${r.cp.toFixed(2)})</option>`;
        });
    };
    
    window.addToRecipe = () => {
        let idx = document.getElementById('selectIngredient').value;
        let q = parseFloat(document.getElementById('useQty').value);
        if(idx !== "" && q > 0) {
            let item = window.rawStock[idx];
            window.recipe.push({ name: item.name, qty: q, cost: item.cp * q });
            renderRecipe();
        }
    };

    function renderRecipe() {
        let tb = document.getElementById('recipeTable'), t = 0; tb.innerHTML = '';
        window.recipe.forEach((r, i) => {
            t += r.cost;
            tb.innerHTML += `<tr><td>${r.name}</td><td>${r.qty}</td><td>${r.cost.toFixed(2)}</td><td><button onclick="window.recipe.splice(${i},1);renderRecipe()">‡∏•‡∏ö</button></td></tr>`;
        });
        document.getElementById('recipeTotal').innerText = t.toFixed(2);
    }

    // --- Settings ---
    window.openShopSettings = async () => {
        const snap = await getDoc(doc(db, "settings", "shop_info"));
        if(snap.exists()) {
            let d = snap.data();
            document.getElementById('shopName').value = d.name;
            document.getElementById('shopAddress').value = d.address;
            document.getElementById('shopTaxID').value = d.taxId;
            document.getElementById('shopPhone').value = d.phone;
        }
        document.getElementById('shopSettingsModal').style.display = 'block';
    };
    window.saveShopSettings = async () => {
        await setDoc(doc(db, "settings", "shop_info"), {
            name: document.getElementById('shopName').value,
            address: document.getElementById('shopAddress').value,
            taxId: document.getElementById('shopTaxID').value,
            phone: document.getElementById('shopPhone').value
        });
        document.getElementById('shopSettingsModal').style.display = 'none';
    };

</script>
</body>
</html>