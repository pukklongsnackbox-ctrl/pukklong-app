<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏û‡∏±‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --primary: #5D4037; --secondary: #8D6E63; --bg: #FDF5E6; --white: #ffffff; --accent: #A1887F; --yellow: #FFA000; --green: #2E7D32; --red: #C62828; --blue: #1976D2; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #4E342E; }
        .container { max-width: 1400px; margin: 0 auto; }
        .hidden { display: none !important; }
        
        /* Auth & Layout */
        .auth-bar { background: rgba(255, 255, 255, 0.95); padding: 15px 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .user-img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary); }
        .action-btn { background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .action-btn:hover { opacity: 0.8; }
        .btn-logout { background: #FFCDD2; color: #C62828; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; }

        /* Navigation Tabs */
        .main-nav { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .nav-item { padding: 12px 20px; background: white; border-radius: 12px; cursor: pointer; font-weight: bold; color: var(--secondary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); white-space: nowrap; }
        .nav-item.active { background: var(--primary); color: white; }

        /* UI Components */
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        input, select, textarea { padding: 10px; border: 1px solid #ddd; border-radius: 8px; width: 100%; box-sizing: border-box; margin-bottom: 10px; font-family: 'Sarabun'; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #F5F5F5; padding: 12px; text-align: left; border-bottom: 2px solid #EEE; font-size: 0.9em; }
        td { padding: 12px; border-bottom: 1px solid #EEE; font-size: 0.9em; }

        /* POS Style */
        .pos-container { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .product-card { background: white; border-radius: 12px; overflow: hidden; cursor: pointer; position: relative; border: 2px solid transparent; transition: 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .product-card:hover { border-color: var(--primary); }
        .product-img { width: 100%; height: 120px; object-fit: cover; background: #EEE; }
        .stock-tag { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 5px; }

        /* Admin Buttons */
        .btn-edit { color: var(--yellow); cursor: pointer; margin-right: 10px; }
        .btn-del { color: var(--red); cursor: pointer; }

        /* Billing Modal */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); overflow-y: auto; }
        .modal-content { background: white; margin: 2% auto; padding: 30px; width: 90%; max-width: 600px; border-radius: 10px; }
        
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

<div id="login-section" style="text-align:center; padding-top:150px;">
    <div class="card" style="display:inline-block; width: 350px;">
        <h2 style="color:var(--primary);">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ ‡∏û‡∏±‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á</h2>
        <button onclick="loginWithGoogle()" class="action-btn" style="background:#4285F4; width:100%;">
            <i class="fab fa-google"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google
        </button>
    </div>
</div>

<div id="app-section" class="container hidden">
    <div class="auth-bar">
        <div style="display:flex; align-items:center; gap:10px;">
            <img id="userImg" class="user-img">
            <div><b id="userName">User</b> <span id="roleBadge" style="background:red; color:white; font-size:0.7em; padding:2px 5px; border-radius:5px; display:none;">ADMIN</span></div>
        </div>
        <button onclick="logout()" class="btn-logout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <div class="main-nav">
        <div class="nav-item active" onclick="switchView('pos', this)"><i class="fas fa-cash-register"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</div>
        <div class="nav-item" onclick="switchView('cost', this)"><i class="fas fa-calculator"></i> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</div>
        <div class="nav-item admin-only" onclick="switchView('inventory', this)"><i class="fas fa-boxes"></i> ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö/‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
        <div class="nav-item admin-only" onclick="switchView('reports', this)"><i class="fas fa-chart-line"></i> ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ</div>
    </div>

    <div id="view-pos" class="view-section">
        <div class="pos-container">
            <div class="card">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                    <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                    <input type="text" id="posSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." style="width:250px; margin-bottom:0;" oninput="renderPOS()">
                </div>
                <div id="posGrid" class="product-grid"></div>
            </div>
            <div class="card">
                <h3>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                <div id="cartItems" style="min-height: 200px; border-bottom: 1px dashed #DDD;"></div>
                <div style="text-align:right; margin: 20px 0;">
                    <small>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
                    <div id="cartTotal" style="font-size:2em; font-weight:bold; color:var(--primary);">0.00</div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <button onclick="openCheckout('receipt')" class="action-btn" style="background:var(--green);">‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button>
                    <button onclick="openCheckout('quotation')" class="action-btn" style="background:var(--blue);">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</button>
                </div>
                <button onclick="clearCart()" style="width:100%; margin-top:10px; background:#EEE; color:#666; border:none; padding:8px; border-radius:8px; cursor:pointer;">‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
            </div>
        </div>
    </div>

    <div id="view-cost" class="view-section hidden">
        <div style="display:grid; grid-template-columns: 1fr 1.5fr; gap:20px;">
            <div class="card">
                <h3>1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö (‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡∏•‡∏≤‡∏á)</h3>
                <div class="admin-only" style="background:#F9F9F9; padding:15px; border-radius:10px; margin-bottom:15px;">
                    <input type="hidden" id="costMatId">
                    <input type="text" id="costMatName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö">
                    <div style="display:flex; gap:5px;">
                        <input type="number" id="costMatPrice" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠">
                        <input type="number" id="costMatQty" placeholder="‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì">
                        <select id="costMatUnit" style="width:100px;">
                            <option value="‡∏Å‡∏£‡∏±‡∏°">‡∏Å‡∏£‡∏±‡∏°</option>
                            <option value="‡∏°‡∏•.">‡∏°‡∏•.</option>
                            <option value="‡∏ä‡∏¥‡πâ‡∏ô">‡∏ä‡∏¥‡πâ‡∏ô</option>
                        </select>
                    </div>
                    <button onclick="saveCostMaterial()" class="action-btn" style="width:100%;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</button>
                </div>
                <div style="max-height:400px; overflow-y:auto;">
                    <table id="costMatTable"></table>
                </div>
            </div>
            <div class="card">
                <h3>2. ‡∏ú‡∏™‡∏°‡∏™‡∏π‡∏ï‡∏£ & ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</h3>
                <div style="display:flex; gap:10px; background:#EEE; padding:15px; border-radius:10px;">
                    <select id="selectRecipeMat" style="margin-bottom:0;"></select>
                    <input type="number" id="recipeUseQty" placeholder="‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?" style="width:120px; margin-bottom:0;">
                    <button onclick="addToRecipe()" class="action-btn" style="background:var(--primary); white-space:nowrap;">+ ‡πÉ‡∏™‡πà‡∏™‡∏π‡∏ï‡∏£</button>
                </div>
                <table id="currentRecipeTable"></table>
                <div style="background:var(--green-soft); padding:20px; margin-top:20px; border-radius:10px; text-align:right;">
                    <div style="font-size:1.2em;">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°: <b id="recipeTotalCost" style="color:var(--green);">0.00</b> ‡∏ö.</div>
                    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
                        <input type="number" id="recipeYield" placeholder="‡πÑ‡∏î‡πâ‡∏Å‡∏µ‡πà‡∏ä‡∏¥‡πâ‡∏ô?" style="width:100px; margin-bottom:0;">
                        <input type="text" id="recipeMenuName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π" style="width:200px; margin-bottom:0;">
                        <button onclick="saveFinalRecipe()" class="action-btn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏π‡∏ï‡∏£</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="view-inventory" class="view-section hidden">
        <div class="card">
            <h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢ (Finished Goods)</h3>
            <div style="display:grid; grid-template-columns: repeat(5, 1fr) auto; gap:5px; margin-bottom:15px;">
                <input type="hidden" id="prodId">
                <input type="text" id="prodName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
                <input type="number" id="prodPrice" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢">
                <input type="number" id="prodStock" placeholder="‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠">
                <input type="text" id="prodImg" placeholder="Link ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û">
                <button onclick="saveProduct()" class="action-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
            <table id="adminProdTable"></table>
        </div>
        <div class="card">
            <h3>‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô (Store Stock)</h3>
            <div style="display:grid; grid-template-columns: repeat(3, 1fr) auto; gap:5px; margin-bottom:15px;">
                <input type="hidden" id="invId">
                <input type="text" id="invName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö">
                <input type="number" id="invQty" placeholder="‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠">
                <input type="text" id="invUnit" placeholder="‡∏´‡∏ô‡πà‡∏ß‡∏¢">
                <button onclick="saveInventory()" class="action-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
            <table id="adminInvTable"></table>
        </div>
    </div>

    <div id="view-reports" class="view-section hidden">
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:20px; margin-bottom:20px;">
            <div class="card" style="text-align:center; background:#E8F5E9;">
                <small>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</small>
                <h2 id="reportTodayTotal" style="color:var(--green); margin:5px 0;">0.00</h2>
            </div>
            <div class="card" style="text-align:center; background:#E3F2FD;">
                <small>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</small>
                <h2 id="reportTodayOrders" style="color:var(--blue); margin:5px 0;">0</h2>
            </div>
            <div class="card" style="text-align:center; background:#FFF3E0;">
                <small>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small>
                <h2 id="reportGrandTotal" style="color:var(--yellow); margin:5px 0;">0.00</h2>
            </div>
        </div>
        <div class="card">
            <h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
            <table id="salesHistoryTable"></table>
        </div>
    </div>
</div>

<div id="checkoutModal" class="modal">
    <div class="modal-content">
        <div id="printArea">
            <div style="text-align:center; margin-bottom:20px;">
                <h2 id="billHeader">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h2>
                <p><b>‡∏£‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á Puk-Klong</b><br>123 ‡∏ñ‡∏ô‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏ï.‡πÉ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏à.‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å</p>
            </div>
            <div style="margin-bottom:10px;">
                <span id="billDate"></span> | ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: <span id="billNo"></span>
            </div>
            <div id="customerInfo" class="no-print" style="margin-bottom:15px;">
                <input type="text" id="billCustName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
                <textarea id="billCustAddr" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"></textarea>
            </div>
            <div id="billPrintCust" style="display:none; margin-bottom:15px;"></div>
            <table style="width:100%; border-top:1px solid #000;">
                <thead><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th align="right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th align="right">‡∏£‡∏≤‡∏Ñ‡∏≤</th><th align="right">‡∏£‡∏ß‡∏°</th></tr></thead>
                <tbody id="billItems"></tbody>
            </table>
            <div style="text-align:right; margin-top:20px; font-size:1.5em; border-top:1px solid #000; padding-top:10px;">
                ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô: <span id="billGrandTotal">0.00</span> ‡∏ö‡∏≤‡∏ó
            </div>
            <div style="margin-top:40px; text-align:center; font-size:0.8em;">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</div>
        </div>
        <div class="no-print" style="margin-top:20px; display:flex; gap:10px;">
            <button id="btnConfirmSale" onclick="confirmTransaction()" class="action-btn" style="flex:1; background:var(--green);">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå</button>
            <button onclick="document.getElementById('checkoutModal').style.display='none'" class="action-btn" style="flex:1; background:#666;">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, setDoc, updateDoc, increment, query, orderBy, Timestamp, getDoc, where } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCzi6OehJGWJwKoaFcYbdIfC7PZrK3er8c",
      authDomain: "pukklong-cost-a10b8.firebaseapp.com",
      projectId: "pukklong-cost-a10b8", 
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const ADMIN_EMAIL = "pukklong.snackbox@gmail.com";

    let currentUser = null, isAdmin = false;
    let products = [], materials = [], cart = [], currentRecipe = [], currentBillType = 'receipt';

    // --- AUTH LOGIC ---
    window.loginWithGoogle = () => signInWithPopup(auth, provider);
    window.logout = () => signOut(auth).then(()=>location.reload());

    onAuthStateChanged(auth, async (user) => {
        if(user) {
            currentUser = user; isAdmin = (user.email === ADMIN_EMAIL);
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('app-section').classList.remove('hidden');
            document.getElementById('userImg').src = user.photoURL;
            document.getElementById('userName').innerText = user.displayName;
            if(isAdmin) {
                document.getElementById('roleBadge').style.display = 'inline-block';
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
            }
            loadAllData();
        }
    });

    async function loadAllData() {
        await Promise.all([fetchProducts(), fetchMaterials(), fetchInventory(), fetchSalesHistory()]);
    }

    // --- NAVIGATION ---
    window.switchView = (view, el) => {
        document.querySelectorAll('.view-section').forEach(v => v.classList.add('hidden'));
        document.getElementById(`view-${view}`).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        if(view === 'reports') renderReports();
    };

    // --- POS LOGIC ---
    async function fetchProducts() {
        const snap = await getDocs(collection(db, "products"));
        products = snap.docs.map(d => ({id: d.id, ...d.data()}));
        renderPOS();
        renderAdminProducts();
    }

    window.renderPOS = () => {
        const search = document.getElementById('posSearch').value.toLowerCase();
        let h = '';
        products.filter(p => p.name.toLowerCase().includes(search)).forEach(p => {
            h += `<div class="product-card" onclick="addToCart('${p.id}')">
                <div class="stock-tag">‡∏™‡∏ï‡πá‡∏≠‡∏Å: ${p.stock}</div>
                <img src="${p.img || 'https://via.placeholder.com/150'}" class="product-img">
                <div style="padding:10px; text-align:center;"><b>${p.name}</b><br><span style="color:var(--primary);">${p.price} ‡∏ö.</span></div>
            </div>`;
        });
        document.getElementById('posGrid').innerHTML = h;
    };

    window.addToCart = (id) => {
        const p = products.find(x => x.id === id);
        const item = cart.find(x => x.id === id);
        if(item) {
            if(item.qty < p.stock) item.qty++;
            else alert('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏≠');
        } else {
            if(p.stock > 0) cart.push({...p, qty: 1});
            else alert('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î');
        }
        renderCart();
    };

    function renderCart() {
        let h = '', total = 0;
        cart.forEach((c, i) => {
            let sum = c.price * c.qty;
            total += sum;
            h += `<div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <div><b>${c.name}</b><br><small>${c.price} x ${c.qty}</small></div>
                <div>${sum.toFixed(2)} <span onclick="removeFromCart(${i})" style="color:red; cursor:pointer;">&times;</span></div>
            </div>`;
        });
        document.getElementById('cartItems').innerHTML = h || '<p style="color:#999; text-align:center;">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</p>';
        document.getElementById('cartTotal').innerText = total.toFixed(2);
    }

    window.removeFromCart = (i) => { cart.splice(i, 1); renderCart(); };
    window.clearCart = () => { cart = []; renderCart(); };

    // --- CHECKOUT & BILLING ---
    window.openCheckout = (type) => {
        if(!cart.length) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
        currentBillType = type;
        document.getElementById('billHeader').innerText = type === 'receipt' ? '‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô' : '‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤';
        document.getElementById('billNo').innerText = (type === 'receipt' ? 'REC-' : 'QUO-') + Date.now().toString().slice(-6);
        document.getElementById('billDate').innerText = new Date().toLocaleString('th-TH');
        
        let h = '', total = 0;
        cart.forEach(c => {
            let sum = c.price * c.qty;
            total += sum;
            h += `<tr><td>${c.name}</td><td align="right">${c.qty}</td><td align="right">${c.price}</td><td align="right">${sum.toFixed(2)}</td></tr>`;
        });
        document.getElementById('billItems').innerHTML = h;
        document.getElementById('billGrandTotal').innerText = total.toFixed(2);
        document.getElementById('checkoutModal').style.display = 'block';
    };

    window.confirmTransaction = async () => {
        const total = parseFloat(document.getElementById('billGrandTotal').innerText);
        const billNo = document.getElementById('billNo').innerText;
        const custName = document.getElementById('billCustName').value;
        const custAddr = document.getElementById('billCustAddr').value;

        try {
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Database
            await addDoc(collection(db, "sales"), {
                billNo, type: currentBillType, items: cart, total, 
                customer: { name: custName, addr: custAddr },
                date: Timestamp.now(), status: 'active'
            });

            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏à‡∏£‡∏¥‡∏á
            if(currentBillType === 'receipt') {
                for(let item of cart) {
                    await updateDoc(doc(db, "products", item.id), { stock: increment(-item.qty) });
                }
            }

            window.print();
            alert("‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            cart = []; renderCart(); loadAllData();
            document.getElementById('checkoutModal').style.display = 'none';
        } catch(e) { console.error(e); }
    };

    // --- COST CALCULATOR LOGIC ---
    async function fetchMaterials() {
        const snap = await getDocs(collection(db, "global_cost_stock"));
        materials = snap.docs.map(d => ({id: d.id, ...d.data()}));
        let h = '', sel = '<option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö--</option>', i = 1;
        materials.forEach(m => {
            let avg = (m.price/m.qty).toFixed(4);
            h += `<tr><td>${i++}</td><td>${m.name}</td><td>${m.price}/${m.qty}</td><td>${avg}</td>
                <td><i class="fas fa-edit btn-edit" onclick="editCostMat('${m.id}')"></i><i class="fas fa-trash btn-del" onclick="delCostMat('${m.id}')"></i></td></tr>`;
            sel += `<option value="${m.id}">${m.name} (${avg}/${m.unit})</option>`;
        });
        document.getElementById('costMatTable').innerHTML = h;
        document.getElementById('selectRecipeMat').innerHTML = sel;
    }

    window.saveCostMaterial = async () => {
        const id = document.getElementById('costMatId').value;
        const data = {
            name: document.getElementById('costMatName').value,
            price: Number(document.getElementById('costMatPrice').value),
            qty: Number(document.getElementById('costMatQty').value),
            unit: document.getElementById('costMatUnit').value
        };
        if(id) await updateDoc(doc(db, "global_cost_stock", id), data);
        else await addDoc(collection(db, "global_cost_stock"), data);
        document.getElementById('costMatId').value = '';
        fetchMaterials();
    };

    window.addToRecipe = () => {
        const id = document.getElementById('selectRecipeMat').value;
        const use = Number(document.getElementById('recipeUseQty').value);
        if(id && use) {
            const m = materials.find(x => x.id === id);
            const cost = (m.price/m.qty) * use;
            currentRecipe.push({ name: m.name, use, unit: m.unit, cost, buyInfo: `${m.price}/${m.qty}` });
            renderCurrentRecipe();
        }
    };

    function renderCurrentRecipe() {
        let h = '', total = 0;
        currentRecipe.forEach((r, i) => {
            total += r.cost;
            h += `<tr><td>${r.name}</td><td>${r.use} ${r.unit}</td><td>${r.cost.toFixed(2)}</td><td onclick="currentRecipe.splice(${i},1);renderCurrentRecipe()">&times;</td></tr>`;
        });
        document.getElementById('currentRecipeTable').innerHTML = h;
        document.getElementById('recipeTotalCost').innerText = total.toFixed(2);
    }

    window.saveFinalRecipe = async () => {
        const name = document.getElementById('recipeMenuName').value;
        if(!name || !currentRecipe.length) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°');
        await addDoc(collection(db, "saved_recipes"), {
            name, items: currentRecipe, yield: Number(document.getElementById('recipeYield').value),
            total: Number(document.getElementById('recipeTotalCost').innerText), date: Timestamp.now()
        });
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        currentRecipe = []; renderCurrentRecipe();
    };

    // --- INVENTORY MGMT ---
    async function fetchInventory() {
        const snap = await getDocs(collection(db, "store_inventory"));
        let h = '';
        snap.forEach(d => {
            let data = d.data();
            h += `<tr><td>${data.name}</td><td>${data.qty} ${data.unit}</td>
                <td><i class="fas fa-edit btn-edit" onclick="editInv('${d.id}')"></i><i class="fas fa-trash btn-del" onclick="delInv('${d.id}')"></i></td></tr>`;
        });
        document.getElementById('adminInvTable').innerHTML = h;
    }

    window.saveInventory = async () => {
        const id = document.getElementById('invId').value;
        const data = {
            name: document.getElementById('invName').value,
            qty: Number(document.getElementById('invQty').value),
            unit: document.getElementById('invUnit').value
        };
        if(id) await updateDoc(doc(db, "store_inventory", id), data);
        else await addDoc(collection(db, "store_inventory"), data);
        document.getElementById('invId').value = '';
        fetchInventory();
    };

    function renderAdminProducts() {
        let h = '';
        products.forEach(p => {
            h += `<tr><td><img src="${p.img}" width="30"></td><td>${p.name}</td><td>${p.price}</td><td>${p.stock}</td>
                <td><i class="fas fa-edit btn-edit" onclick="editProd('${p.id}')"></i><i class="fas fa-trash btn-del" onclick="delProd('${p.id}')"></i></td></tr>`;
        });
        document.getElementById('adminProdTable').innerHTML = h;
    }

    window.saveProduct = async () => {
        const id = document.getElementById('prodId').value;
        const data = {
            name: document.getElementById('prodName').value,
            price: Number(document.getElementById('prodPrice').value),
            stock: Number(document.getElementById('prodStock').value),
            img: document.getElementById('prodImg').value
        };
        if(id) await updateDoc(doc(db, "products", id), data);
        else await setDoc(doc(db, "products", data.name), data);
        document.getElementById('prodId').value = '';
        fetchProducts();
    };

    // --- REPORTS ---
    async function fetchSalesHistory() {
        const q = query(collection(db, "sales"), orderBy("date", "desc"));
        const snap = await getDocs(q);
        let h = '', todayTotal = 0, todayOrders = 0, grandTotal = 0;
        const todayStr = new Date().toLocaleDateString();

        snap.forEach(d => {
            let s = d.data();
            let date = s.date.toDate();
            grandTotal += s.total;
            if(date.toLocaleDateString() === todayStr) {
                todayTotal += s.total;
                todayOrders++;
            }

            h += `<tr><td>${date.toLocaleString('th-TH')}</td><td>${s.billNo}</td><td>${s.total.toFixed(2)}</td><td>${s.type.toUpperCase()}</td>
                <td><button onclick="voidSale('${d.id}')" class="btn-del" style="border:none; background:none;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></td></tr>`;
        });
        document.getElementById('salesHistoryTable').innerHTML = h;
        document.getElementById('reportTodayTotal').innerText = todayTotal.toFixed(2);
        document.getElementById('reportTodayOrders').innerText = todayOrders;
        document.getElementById('reportGrandTotal').innerText = grandTotal.toFixed(2);
    }

    window.voidSale = async (id) => {
        if(confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) {
            await deleteDoc(doc(db, "sales", id));
            fetchSalesHistory();
        }
    };

    // Edit Helpers
    window.editCostMat = (id) => {
        let m = materials.find(x => x.id === id);
        document.getElementById('costMatId').value = m.id;
        document.getElementById('costMatName').value = m.name;
        document.getElementById('costMatPrice').value = m.price;
        document.getElementById('costMatQty').value = m.qty;
        document.getElementById('costMatUnit').value = m.unit;
    };
    window.editProd = (id) => {
        let p = products.find(x => x.id === id);
        document.getElementById('prodId').value = p.id;
        document.getElementById('prodName').value = p.name;
        document.getElementById('prodPrice').value = p.price;
        document.getElementById('prodStock').value = p.stock;
        document.getElementById('prodImg').value = p.img;
    };
    window.delProd = async (id) => { if(confirm('‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ?')) { await deleteDoc(doc(db, "products", id)); fetchProducts(); } };
    window.delCostMat = async (id) => { if(confirm('‡∏•‡∏ö‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ô‡∏µ‡πâ?')) { await deleteDoc(doc(db, "global_cost_stock", id)); fetchMaterials(); } };

</script>
</body>
</html>
