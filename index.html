<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏û‡∏±‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --primary: #5D4037; --secondary: #8D6E63; --bg: #FDF5E6; --white: #ffffff; --accent: #A1887F; --yellow: #FFA000; --green-soft: #F1F8E9; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #4E342E; }
        .container { max-width: 1200px; margin: 0 auto; }
        .hidden { display: none !important; }
        
        /* Auth & Layout */
        .auth-bar { background: rgba(255, 255, 255, 0.95); padding: 15px 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .user-img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary); }
        .btn-logout { background: #FFCDD2; color: #C62828; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; }
        .action-btn { background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .edit-btn { background: #E3F2FD; color: #1976D2; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        .delete-btn { background: #FFEBEE; color: #C62828; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        
        /* Inputs & Tables */
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 5px; width: 100%; box-sizing: border-box; margin-bottom: 5px; font-family: 'Sarabun'; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; margin-top: 10px; }
        th { background: #eee; padding: 10px; text-align: left; font-size: 0.9em; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9em; }

        /* Dashboard Menu */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 40px; }
        .menu-card { background: white; padding: 40px; border-radius: 20px; text-align: center; cursor: pointer; transition: 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 2px solid transparent; }
        .menu-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .menu-card i { font-size: 4em; color: var(--primary); margin-bottom: 20px; }
        .menu-card h2 { margin: 0; color: #4E342E; }

        /* Tab System */
        .tab-menu { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 12px; background: #EFEBE9; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: var(--secondary); }
        .tab-btn.active { background: var(--primary); color: white; }

        /* POS Grid */
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .product-item { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; position: relative; }
        .product-img { width: 100%; height: 120px; object-fit: cover; background: #ddd; }
        .product-info { padding: 10px; text-align: center; }
        .stock-tag { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 4px; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow-y: auto; }
        .modal-content { background: white; margin: 2% auto; padding: 25px; width: 90%; max-width: 550px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        
        @media print {
            body * { visibility: hidden; }
            #printableArea, #printableArea * { visibility: visible; }
            #printableArea { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
        }

        .bill-table { width: 100%; font-size: 0.85em; margin-top: 10px; border-top: 1px solid #000; }
        .bill-table th { background: none; border-bottom: 1px dashed #000; }
        .bill-table td { border-bottom: 1px dashed #eee; }
    </style>
</head>
<body>

<div id="login-section" style="text-align:center; padding-top:100px;">
    <div style="background:white; padding:40px; border-radius:20px; display:inline-block; box-shadow:0 10px 30px rgba(0,0,0,0.1);">
        <h2 style="color:var(--primary);">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô ‡∏û‡∏±‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á</h2>
        <button onclick="loginWithGoogle()" class="action-btn" style="background:#4285F4; margin-top:20px; padding: 12px 25px;">
            <i class="fab fa-google"></i> Login ‡∏î‡πâ‡∏ß‡∏¢ Google
        </button>
    </div>
</div>

<div id="app-section" class="container hidden">
    <div class="auth-bar">
        <div style="display:flex; align-items:center; gap:10px;">
            <img id="userImg" class="user-img">
            <div>
                <b id="userName">User</b>
                <span id="roleBadge" style="background:red; color:white; font-size:0.7em; padding:2px 5px; border-radius:5px; display:none;">ADMIN</span>
            </div>
        </div>
        <div>
            <button onclick="goHome()" class="action-btn" style="background:#8D6E63;">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
            <button onclick="logout()" class="btn-logout">‡∏≠‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="dashboard-view">
        <div class="dashboard-grid">
            <div class="menu-card" onclick="openSystem('pos')">
                <i class="fas fa-store"></i>
                <h2>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å & ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (POS)</h2>
                <p>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
            </div>
            <div class="menu-card" onclick="openSystem('cost')">
                <i class="fas fa-calculator"></i>
                <h2>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</h2>
                <p>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏°‡∏ô‡∏π</p>
            </div>
        </div>
    </div>

    <div id="pos-view" class="hidden">
        <h2 style="color:var(--primary); border-bottom:2px solid var(--secondary);">‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô & ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
        <div class="tab-menu">
            <button class="tab-btn active" onclick="openPosTab('sales')">üõí ‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
            <button class="tab-btn" id="btnStock" onclick="openPosTab('stock')">üì¶ ‡∏™‡∏ï‡πá‡∏≠‡∏Å (Admin)</button>
            <button class="tab-btn" id="btnHistory" onclick="openPosTab('history')">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≤‡∏¢ (Admin)</button>
        </div>
        <div id="pos-sales" class="pos-tab active">
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                <div id="productGrid" class="product-grid">Loading...</div>
                <div style="background:white; padding:20px; border-radius:10px; height:fit-content;">
                    <h3>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                    <div id="cartItems"></div>
                    <div style="text-align:right; font-size:1.5em; font-weight:bold; margin:20px 0; color:var(--primary);">
                        ‡∏£‡∏ß‡∏°: <span id="cartTotal">0.00</span>
                    </div>
                    <button onclick="checkout('simple')" class="action-btn" style="background:#4CAF50; width:100%; margin-bottom:5px;">‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</button>
                </div>
            </div>
        </div>
        <div id="pos-stock" class="pos-tab hidden">
            <div style="background:white; padding:20px; border-radius:10px;">
                <h3>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô</h3>
                <div id="pos-admin-prod-form" style="display:flex; gap:5px; margin-bottom:15px;">
                    <input type="text" id="prodName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π">
                    <input type="number" id="prodPrice" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢">
                    <input type="number" id="prodStock" placeholder="‡∏™‡∏ï‡πá‡∏≠‡∏Å">
                    <button onclick="addProd()" class="action-btn">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                </div>
                <table id="prodTable"></table>
            </div>
        </div>
        <div id="pos-history" class="pos-tab hidden">
             <table id="saleHistoryTable"></table>
        </div>
    </div>

    <div id="cost-view" class="hidden">
        <h2 style="color:var(--primary); border-bottom:2px solid var(--secondary);">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏≠‡∏¥‡∏™‡∏£‡∏∞</h2>
        <div class="tab-menu">
            <button class="tab-btn active" onclick="openCalcTab('calc')">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î‡πÄ‡∏•‡∏Ç & ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</button>
            <button class="tab-btn" onclick="openCalcTab('saved')">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>

        <div id="calc-main" class="calc-tab active">
            <div style="background:#FFF8E1; padding:20px; border-radius:10px; margin-bottom:20px; border:1px solid #FFE0B2;">
                <h3 style="margin-top:0;">1. ‡∏Ñ‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)</h3>
                <div id="material-admin-only" style="display:none; gap:5px; margin-bottom:15px;">
                    <input type="hidden" id="editMatId">
                    <input type="text" id="cStockName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö (‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏õ‡πâ‡∏á)">
                    <input type="number" id="cStockPrice" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠ (‡∏ö‡∏≤‡∏ó)">
                    <input type="number" id="cStockQty" placeholder="‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠">
                    <select id="cStockUnit" style="width:120px;">
                        <option value="‡∏Å‡∏£‡∏±‡∏°">‡∏Å‡∏£‡∏±‡∏° (g)</option>
                        <option value="‡∏°‡∏•.">‡∏°‡∏•. (ml)</option>
                        <option value="‡∏ä‡∏¥‡πâ‡∏ô">‡∏ä‡∏¥‡πâ‡∏ô</option>
                        <option value="‡∏ñ‡∏∏‡∏á">‡∏ñ‡∏∏‡∏á</option>
                        <option value="‡∏ü‡∏≠‡∏á">‡∏ü‡∏≠‡∏á</option>
                    </select>
                    <button onclick="saveCostMaterial()" class="action-btn" id="btnMatSave">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≠‡∏á</button>
                </div>
                <div style="max-height:200px; overflow-y:auto; background:white; border-radius:8px;">
                    <table>
                        <thead>
                            <tr><th width="40">#</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</th><th>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ã‡∏∑‡πâ‡∏≠</th><th>‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th width="100">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr>
                        </thead>
                        <tbody id="cStockTable"></tbody>
                    </table>
                </div>
            </div>

            <div style="background:white; padding:20px; border-radius:10px; border:1px solid #ddd;">
                <h3 style="margin-top:0;">2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏°‡∏ô‡∏π</h3>
                <div style="display:flex; gap:10px; align-items:flex-end; background:#F5F5F5; padding:15px; border-radius:8px;">
                    <div style="flex:2;">
                        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á</label>
                        <select id="cSelectIng"></select>
                    </div>
                    <div style="flex:1;">
                        <label>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</label>
                        <input type="number" id="cUseQty" placeholder="0">
                    </div>
                    <button onclick="addToRecipe()" class="action-btn" style="background:#6D4C41; margin-bottom:5px;">+ ‡πÉ‡∏™‡πà‡∏´‡∏°‡πâ‡∏≠</button>
                </div>
                
                <table>
                    <thead><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</th><th>‡∏ó‡∏∏‡∏ô</th><th>‡∏•‡∏ö</th></tr></thead>
                    <tbody id="recipeTable"></tbody>
                </table>

                <div style="background:#E0F2F1; padding:15px; margin-top:15px; text-align:right; border-radius:10px;">
                    <div>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏™‡∏π‡∏ï‡∏£‡∏ô‡∏µ‡πâ: <b id="totalCost" style="font-size:1.5em; color:green;">0.00</b> ‡∏ö‡∏≤‡∏ó</div>
                    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
                        <input type="number" id="yieldQty" placeholder="‡πÅ‡∏ö‡πà‡∏á‡πÑ‡∏î‡πâ‡∏Å‡∏µ‡πà‡∏ä‡∏¥‡πâ‡∏ô?" style="width:120px;">
                        <input type="text" id="menuName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π" style="width:200px;">
                        <button onclick="saveFullRecipe()" class="action-btn" style="background:#2E7D32;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏π‡∏ï‡∏£</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="calc-saved" class="calc-tab hidden">
            <div style="background:white; padding:20px; border-radius:10px;">
                <h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏π‡∏ï‡∏£ (‡∏Å‡∏î‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)</h3>
                <div id="savedRecipeList"></div>
            </div>
        </div>
    </div>
</div>

<div id="recipeDetailModal" class="modal">
    <div class="modal-content">
        <h2 id="detMenuName" style="color:var(--primary); margin:0;"></h2>
        <p id="detDate" style="color:#666; font-size:0.8em;"></p>
        <hr>
        <table class="bill-table">
            <thead>
                <tr><th>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</th><th align="right">‡πÉ‡∏ä‡πâ‡πÑ‡∏õ</th><th align="right">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠</th><th align="right">‡∏ó‡∏∏‡∏ô‡πÉ‡∏ô‡∏™‡∏π‡∏ï‡∏£</th></tr>
            </thead>
            <tbody id="detItems"></tbody>
        </table>
        <div style="margin-top:20px; text-align:right;">
            <div id="detTotal" style="font-size:1.1em;"></div>
            <div id="detPerPiece" style="color:green; font-weight:bold; font-size:1.3em;"></div>
        </div>
        <div style="text-align:center; margin-top:20px;">
            <button onclick="document.getElementById('recipeDetailModal').style.display='none'" class="action-btn">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, setDoc, updateDoc, increment, query, orderBy, Timestamp, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCzi6OehJGWJwKoaFcYbdIfC7PZrK3er8c",
      authDomain: "pukklong-cost-a10b8.firebaseapp.com",
      projectId: "pukklong-cost-a10b8", 
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const ADMIN_EMAIL = "pukklong.snackbox@gmail.com";

    let currentUser = null, isAdmin = false;
    window.products = []; window.cart = [];
    window.costStock = []; window.currentRecipe = [];

    // --- Auth Logic ---
    window.loginWithGoogle = () => signInWithPopup(auth, provider);
    window.logout = () => signOut(auth).then(()=>location.reload());

    onAuthStateChanged(auth, async (user) => {
        if(user) {
            currentUser = user; isAdmin = (user.email === ADMIN_EMAIL);
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('app-section').classList.remove('hidden');
            document.getElementById('userImg').src = user.photoURL;
            document.getElementById('userName').innerText = user.displayName;
            
            if(isAdmin) {
                document.getElementById('roleBadge').style.display = 'inline-block';
                document.getElementById('material-admin-only').style.display = 'flex';
                document.getElementById('btnStock').style.display = 'block';
                document.getElementById('btnHistory').style.display = 'block';
            }
            fetchProducts();
            fetchCostStock();
        }
    });

    window.goHome = () => {
        document.getElementById('dashboard-view').classList.remove('hidden');
        document.getElementById('pos-view').classList.add('hidden');
        document.getElementById('cost-view').classList.add('hidden');
    };
    window.openSystem = (sys) => {
        document.getElementById('dashboard-view').classList.add('hidden');
        if(sys === 'pos') document.getElementById('pos-view').classList.remove('hidden');
        else {
            document.getElementById('cost-view').classList.remove('hidden');
            fetchCostStock();
        }
    };

    // --- COST CALCULATOR LOGIC (UPDATED) ---

    // 1. Fetch Master Materials
    async function fetchCostStock() {
        const snap = await getDocs(collection(db, "global_cost_stock"));
        window.costStock = [];
        let h = '', sel = '<option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á--</option>';
        let i = 1;
        snap.forEach(d => {
            let dt = d.data();
            window.costStock.push({id:d.id, ...dt});
            let avg = (dt.price / dt.qty).toFixed(4);
            h += `<tr>
                <td>${i++}</td>
                <td><b>${dt.name}</b></td>
                <td>${dt.price} ‡∏ö. / ${dt.qty} ${dt.unit}</td>
                <td style="color:#795548">${avg} ‡∏ö./${dt.unit}</td>
                <td>
                    ${isAdmin ? `
                        <button onclick="editCostMaterial('${d.id}')" class="edit-btn"><i class="fas fa-edit"></i></button>
                        <button onclick="delCostStock('${d.id}')" class="delete-btn"><i class="fas fa-trash"></i></button>
                    ` : '-'}
                </td>
            </tr>`;
            sel += `<option value="${d.id}">${dt.name} (‡∏ó‡∏∏‡∏ô: ${avg}/${dt.unit})</option>`;
        });
        document.getElementById('cStockTable').innerHTML = h || '<tr><td colspan="5">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
        document.getElementById('cSelectIng').innerHTML = sel;
    }

    // 2. Save/Update Master Material (Admin Only)
    window.saveCostMaterial = async () => {
        if(!isAdmin) return;
        let id = document.getElementById('editMatId').value;
        let n = document.getElementById('cStockName').value;
        let p = Number(document.getElementById('cStockPrice').value);
        let q = Number(document.getElementById('cStockQty').value);
        let u = document.getElementById('cStockUnit').value;

        if(n && p && q) {
            let data = { name:n, price:p, qty:q, unit:u };
            if(id) await updateDoc(doc(db, "global_cost_stock", id), data);
            else await addDoc(collection(db, "global_cost_stock"), data);
            
            resetMatForm();
            fetchCostStock();
        }
    };

    window.editCostMaterial = (id) => {
        let m = window.costStock.find(x => x.id === id);
        if(m) {
            document.getElementById('editMatId').value = id;
            document.getElementById('cStockName').value = m.name;
            document.getElementById('cStockPrice').value = m.price;
            document.getElementById('cStockQty').value = m.qty;
            document.getElementById('cStockUnit').value = m.unit;
            document.getElementById('btnMatSave').innerText = "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï";
        }
    };

    function resetMatForm() {
        document.getElementById('editMatId').value = '';
        document.getElementById('cStockName').value = '';
        document.getElementById('cStockPrice').value = '';
        document.getElementById('cStockQty').value = '';
        document.getElementById('btnMatSave').innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≠‡∏á";
    }

    window.delCostStock = async(id) => { if(confirm('‡∏•‡∏ö‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ô‡∏µ‡πâ‡∏ñ‡∏≤‡∏ß‡∏£?')) { await deleteDoc(doc(db,"global_cost_stock",id)); fetchCostStock(); }};

    // 3. Mixing Recipe Logic
    window.addToRecipe = () => {
        let id = document.getElementById('cSelectIng').value;
        let use = parseFloat(document.getElementById('cUseQty').value);
        if(id && use) {
            let item = window.costStock.find(x => x.id === id);
            let totalCost = (item.price / item.qty) * use;
            window.currentRecipe.push({ 
                name: item.name, use: use, unit: item.unit, cost: totalCost,
                buyPrice: item.price, buyQty: item.qty
            });
            renderRecipe();
            document.getElementById('cUseQty').value = '';
        }
    };

    window.renderRecipe = () => {
        let h = '', t = 0;
        window.currentRecipe.forEach((r,i) => {
            t += r.cost;
            h += `<tr><td>${r.name}</td><td>${r.use} ${r.unit}</td><td>${r.cost.toFixed(2)}</td><td><button onclick="window.currentRecipe.splice(${i},1);renderRecipe()" class="delete-btn">x</button></td></tr>`;
        });
        document.getElementById('recipeTable').innerHTML = h;
        document.getElementById('totalCost').innerText = t.toFixed(2);
    };

    // 4. Save Recipe to History (Full Detail)
    window.saveFullRecipe = async () => {
        let name = document.getElementById('menuName').value;
        let yld = document.getElementById('yieldQty').value;
        let total = parseFloat(document.getElementById('totalCost').innerText);
        
        if(name && window.currentRecipe.length > 0) {
            await addDoc(collection(db, "saved_recipes"), {
                name: name,
                ingredients: window.currentRecipe,
                totalCost: total,
                yield: yld,
                date: Timestamp.now()
            });
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏π‡∏ï‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
            window.currentRecipe = []; renderRecipe();
            document.getElementById('menuName').value = '';
            document.getElementById('yieldQty').value = '';
            fetchSavedRecipes();
            openCalcTab('saved');
        }
    };

    // 5. History Listing (Brief)
    window.fetchSavedRecipes = async () => {
        const q = query(collection(db, "saved_recipes"), orderBy("date", "desc"));
        const snap = await getDocs(q);
        let h = '';
        snap.forEach(d => {
            let r = d.data();
            let date = r.date.toDate().toLocaleDateString('th-TH');
            h += `
                <div onclick="showRecipeDetail('${d.id}')" style="background:#f9f9f9; padding:15px; margin-bottom:8px; border-radius:10px; cursor:pointer; border-left:5px solid var(--primary); display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <b>${r.name}</b> <br>
                        <small style="color:#666;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${date}</small>
                    </div>
                    <div style="text-align:right;">
                        <span style="color:green; font-weight:bold;">${r.totalCost.toFixed(2)} ‡∏ö.</span> <br>
                        <small>${r.yield ? '‡πÑ‡∏î‡πâ '+r.yield+' ‡∏ä‡∏¥‡πâ‡∏ô' : ''}</small>
                    </div>
                </div>`;
        });
        document.getElementById('savedRecipeList').innerHTML = h || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥';
    };

    // 6. Detailed Detail (Full)
    window.showRecipeDetail = async (id) => {
        const d = await getDoc(doc(db, "saved_recipes", id));
        if(d.exists()) {
            let r = d.data();
            document.getElementById('detMenuName').innerText = r.name;
            document.getElementById('detDate').innerText = "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: " + r.date.toDate().toLocaleString('th-TH');
            let h = '';
            r.ingredients.forEach(i => {
                h += `<tr>
                    <td>${i.name}</td>
                    <td align="right">${i.use} ${i.unit}</td>
                    <td align="right" style="color:#666;">${i.buyPrice}/${i.buyQty}</td>
                    <td align="right">${i.cost.toFixed(2)}</td>
                </tr>`;
            });
            document.getElementById('detItems').innerHTML = h;
            document.getElementById('detTotal').innerText = "‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°: " + r.totalCost.toFixed(2) + " ‡∏ö‡∏≤‡∏ó";
            document.getElementById('detPerPiece').innerText = r.yield ? "‡∏ï‡∏Å‡∏ä‡∏¥‡πâ‡∏ô‡∏•‡∏∞ " + (r.totalCost / r.yield).toFixed(2) + " ‡∏ö‡∏≤‡∏ó" : "";
            document.getElementById('recipeDetailModal').style.display = 'block';
        }
    };

    // --- POS Placeholders (Same as original) ---
    async function fetchProducts() {
        const snap = await getDocs(collection(db, "products"));
        window.products = [];
        let h = '', grid = '';
        snap.forEach(d => {
            let p = {id:d.id, ...d.data()};
            window.products.push(p);
            h += `<tr><td>${p.name}</td><td>${p.price}</td><td>${p.stock}</td><td><button onclick="delProd('${p.id}')" class="delete-btn">‡∏•‡∏ö</button></td></tr>`;
            grid += `<div class="product-item" onclick="addToCart('${p.id}')">
                <div class="stock-tag">${p.stock}</div>
                <div class="product-info"><b>${p.name}</b><br>${p.price} ‡∏ö.</div>
            </div>`;
        });
        document.getElementById('prodTable').innerHTML = h;
        document.getElementById('productGrid').innerHTML = grid;
    }
    window.addProd = async () => {
        let n=document.getElementById('prodName').value, p=document.getElementById('prodPrice').value, s=document.getElementById('prodStock').value;
        if(n && p) { await setDoc(doc(db, "products", n), {name:n, price:Number(p), stock:Number(s)}); fetchProducts(); }
    };
    window.addToCart = (id) => {
        let p = window.products.find(x=>x.id==id);
        let ex = window.cart.find(x=>x.id==id);
        if(ex) ex.qty++; else window.cart.push({...p, qty:1});
        renderCart();
    };
    function renderCart() {
        let h='', t=0;
        window.cart.forEach(c => { t += c.price*c.qty; h += `<div>${c.name} x${c.qty}</div>`; });
        document.getElementById('cartItems').innerHTML = h;
        document.getElementById('cartTotal').innerText = t.toFixed(2);
    }
    window.checkout = async (type) => {
        if(!window.cart.length) return;
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß)");
        window.cart = []; renderCart();
    };

    // --- Tab Helpers ---
    window.openPosTab = (t) => {
        document.querySelectorAll('.pos-tab').forEach(x=>x.classList.add('hidden'));
        document.querySelectorAll('#pos-view .tab-btn').forEach(x=>x.classList.remove('active'));
        if(t=='sales') document.getElementById('pos-sales').classList.remove('hidden');
        if(t=='stock') document.getElementById('pos-stock').classList.remove('hidden');
        if(t=='history') { document.getElementById('pos-history').classList.remove('hidden'); }
        event.target.classList.add('active');
    };
    window.openCalcTab = (t) => {
        document.querySelectorAll('.calc-tab').forEach(x=>x.classList.add('hidden'));
        document.querySelectorAll('#cost-view .tab-btn').forEach(x=>x.classList.remove('active'));
        if(t=='calc') document.getElementById('calc-main').classList.remove('hidden');
        if(t=='saved') { document.getElementById('calc-saved').classList.remove('hidden'); fetchSavedRecipes(); }
        event.target.classList.add('active');
    };

</script>
</body>
</html>

