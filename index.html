<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏û‡∏±‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô (Admin Edition)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --primary: #5D4037; --secondary: #8D6E63; --bg: #FDF5E6; --white: #ffffff; --accent: #A1887F; --yellow: #FFA000; --green: #2E7D32; --red: #C62828; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #4E342E; }
        .container { max-width: 1200px; margin: 0 auto; }
        .hidden { display: none !important; }
        
        /* Auth & Layout */
        .auth-bar { background: rgba(255, 255, 255, 0.95); padding: 15px 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .user-img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary); }
        .action-btn { background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-logout { background: #FFCDD2; color: #C62828; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; }

        /* Tables & UI Components */
        input, select { padding: 10px; border: 1px solid #ccc; border-radius: 5px; width: 100%; box-sizing: border-box; margin-bottom: 5px; font-family: 'Sarabun'; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; margin-top: 10px; font-size: 0.9em; }
        th { background: #f4f4f4; padding: 12px 10px; text-align: left; color: #666; border-bottom: 2px solid #eee; }
        td { padding: 12px 10px; border-bottom: 1px solid #eee; vertical-align: top; }

        /* Admin Buttons (Match Image) */
        .btn-edit { background: #FFF9C4; color: #FBC02D; border: none; width: 30px; height: 30px; border-radius: 5px; cursor: pointer; margin-bottom: 5px; }
        .btn-del { background: #FFEBEE; color: #D32F2F; border: none; width: 30px; height: 30px; border-radius: 5px; cursor: pointer; }

        /* Dashboard */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 40px; }
        .menu-card { background: white; padding: 40px; border-radius: 20px; text-align: center; cursor: pointer; transition: 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .menu-card:hover { transform: translateY(-5px); border: 2px solid var(--primary); }
        .menu-card i { font-size: 4em; color: var(--primary); margin-bottom: 20px; }

        /* Tab System */
        .tab-menu { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 12px; background: #EFEBE9; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: var(--secondary); }
        .tab-btn.active { background: var(--primary); color: white; }

        /* Detailed History Specifics (Match Image) */
        .ing-detail-row { font-size: 0.85em; color: #666; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px dotted #ddd; }
        .ing-sub-text { font-size: 0.8em; color: #999; display: block; }
        .cost-summary-box { background: #F1F8E9; padding: 10px; border-radius: 8px; text-align: center; height: 100%; display: flex; flex-direction: column; justify-content: center; }
        .yield-badge { background: #FFE0B2; color: #E65100; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; }
    </style>
</head>
<body>

<div id="login-section" style="text-align:center; padding-top:100px;">
    <div style="background:white; padding:40px; border-radius:20px; display:inline-block; box-shadow:0 10px 30px rgba(0,0,0,0.1);">
        <h2>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô ‡∏û‡∏±‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á</h2>
        <button onclick="loginWithGoogle()" class="action-btn" style="background:#4285F4;"><i class="fab fa-google"></i> Login Google</button>
    </div>
</div>

<div id="app-section" class="container hidden">
    <div class="auth-bar">
        <div style="display:flex; align-items:center; gap:10px;">
            <img id="userImg" class="user-img">
            <div><b id="userName">User</b> <span id="roleBadge" style="background:red; color:white; font-size:0.7em; padding:2px 5px; border-radius:5px; display:none;">ADMIN</span></div>
        </div>
        <div>
            <button onclick="goHome()" class="action-btn" style="background:#8D6E63;">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
            <button onclick="logout()" class="btn-logout">‡∏≠‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="dashboard-view">
        <div class="dashboard-grid">
            <div class="menu-card" onclick="openSystem('pos')"><i class="fas fa-store"></i><h2>‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (POS)</h2></div>
            <div class="menu-card" onclick="openSystem('cost')"><i class="fas fa-calculator"></i><h2>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</h2></div>
        </div>
    </div>

    <div id="cost-view" class="hidden">
        <h2 style="color:var(--primary); border-bottom:2px solid var(--secondary);">üìã ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô & ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h2>
        <div class="tab-menu">
            <button class="tab-btn active" onclick="openCalcTab('calc')">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</button>
            <button class="tab-btn" onclick="openCalcTab('saved')">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏™‡∏π‡∏ï‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>

        <div id="calc-main" class="calc-tab active">
            <div style="background:#FFF8E1; padding:20px; border-radius:15px; margin-bottom:20px; border:1px solid #FFE0B2;">
                <h3>1. ‡∏Ñ‡∏•‡∏±‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h3>
                <div id="mat-form" style="display:none; gap:5px; margin-bottom:15px;">
                    <input type="hidden" id="matId">
                    <input type="text" id="matName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö">
                    <input type="number" id="matPrice" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠">
                    <input type="number" id="matQty" placeholder="‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ">
                    <select id="matUnit" style="width:120px;">
                        <option value="‡∏Å‡∏£‡∏±‡∏°">‡∏Å‡∏£‡∏±‡∏°</option>
                        <option value="‡∏°‡∏•.">‡∏°‡∏•.</option>
                        <option value="‡∏ä‡∏¥‡πâ‡∏ô">‡∏ä‡∏¥‡πâ‡∏ô</option>
                        <option value="‡∏ü‡∏≠‡∏á">‡∏ü‡∏≠‡∏á</option>
                    </select>
                    <button onclick="saveMaterial()" class="action-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
                <div style="background:white; border-radius:10px; max-height: 250px; overflow-y: auto;">
                    <table>
                        <thead><tr><th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠</th><th>‡∏ó‡∏∏‡∏ô/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th id="matAdminTh" style="display:none;">Admin</th></tr></thead>
                        <tbody id="matTable"></tbody>
                    </table>
                </div>
            </div>

            <div style="background:white; padding:20px; border-radius:15px; border:1px solid #ddd;">
                <h3>2. ‡∏ú‡∏™‡∏°‡∏™‡∏π‡∏ï‡∏£</h3>
                <div style="display:flex; gap:10px; align-items:flex-end; background:#f9f9f9; padding:15px; border-radius:10px;">
                    <div style="flex:2;"><label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</label><select id="selectMat"></select></div>
                    <div style="flex:1;"><label>‡πÉ‡∏ä‡πâ‡πÑ‡∏õ</label><input type="number" id="useQty" placeholder="0"></div>
                    <button onclick="addToRecipe()" class="action-btn" style="background:#6D4C41;">+ ‡πÉ‡∏™‡πà‡∏´‡∏°‡πâ‡∏≠</button>
                </div>
                <table>
                    <thead><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡πÉ‡∏ä‡πâ‡πÑ‡∏õ</th><th>‡∏ó‡∏∏‡∏ô</th><th>‡∏•‡∏ö</th></tr></thead>
                    <tbody id="recipeTable"></tbody>
                </table>
                <div style="background:#E0F2F1; padding:15px; margin-top:15px; text-align:right; border-radius:10px;">
                    <div style="font-size:1.2em;">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°: <b id="currentTotal" style="color:var(--green);">0.00</b> ‡∏ö.</div>
                    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
                        <input type="number" id="yield" placeholder="‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏Å‡∏µ‡πà‡∏ä‡∏¥‡πâ‡∏ô?" style="width:100px;">
                        <input type="text" id="recipeName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π" style="width:200px;">
                        <button onclick="saveRecipe()" class="action-btn" style="background:var(--green);">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏π‡∏ï‡∏£</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="calc-saved" class="calc-tab hidden">
            <div style="background:white; padding:10px; border-radius:10px; overflow-x: auto;">
                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px;">
                    <h3 style="margin:0;">üóí ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</h3>
                    <button onclick="fetchSavedRecipes()" class="action-btn" style="background:#8D6E63; font-size:0.8em;"><i class="fas fa-sync"></i> ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏Ñ‡∏≤</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th width="15%">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / ‡πÄ‡∏ß‡∏•‡∏≤</th>
                            <th width="15%">‡πÄ‡∏°‡∏ô‡∏π / ‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï</th>
                            <th width="45%">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö (‡∏£‡∏≤‡∏Ñ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</th>
                            <th width="15%" style="text-align:center;">‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</th>
                            <th width="10%" style="text-align:center;">Admin</th>
                        </tr>
                    </thead>
                    <tbody id="historyDetailedTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="pos-view" class="hidden"><h2>‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤...</h2><button onclick="goHome()">‡∏Å‡∏•‡∏±‡∏ö</button></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, setDoc, updateDoc, increment, query, orderBy, Timestamp, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyCzi6OehJGWJwKoaFcYbdIfC7PZrK3er8c", authDomain: "pukklong-cost-a10b8.firebaseapp.com", projectId: "pukklong-cost-a10b8" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const ADMIN_EMAIL = "pukklong.snackbox@gmail.com";

    let currentUser = null, isAdmin = false;
    window.materials = []; window.currentRecipe = [];

    // --- AUTH ---
    window.loginWithGoogle = () => signInWithPopup(auth, provider);
    window.logout = () => signOut(auth).then(()=>location.reload());
    
    onAuthStateChanged(auth, async (user) => {
        if(user) {
            currentUser = user; isAdmin = (user.email === ADMIN_EMAIL);
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('app-section').classList.remove('hidden');
            document.getElementById('userImg').src = user.photoURL;
            document.getElementById('userName').innerText = user.displayName;
            if(isAdmin) {
                document.getElementById('roleBadge').style.display = 'inline-block';
                document.getElementById('mat-form').style.display = 'flex';
                document.getElementById('matAdminTh').style.display = 'table-cell';
            }
            fetchMaterials();
        }
    });

    window.goHome = () => {
        document.getElementById('dashboard-view').classList.remove('hidden');
        document.getElementById('pos-view').classList.add('hidden');
        document.getElementById('cost-view').classList.add('hidden');
    };
    window.openSystem = (sys) => {
        document.getElementById('dashboard-view').classList.add('hidden');
        if(sys === 'pos') document.getElementById('pos-view').classList.remove('hidden');
        else { document.getElementById('cost-view').classList.remove('hidden'); fetchMaterials(); }
    };

    // --- MATERIAL MGMT ---
    async function fetchMaterials() {
        const snap = await getDocs(collection(db, "global_cost_stock"));
        window.materials = [];
        let h = '', sel = '<option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å--</option>', count = 1;
        snap.forEach(d => {
            let m = {id:d.id, ...d.data()}; window.materials.push(m);
            let avg = (m.price / m.qty).toFixed(2);
            h += `<tr>
                <td>${count++}</td>
                <td><b>${m.name}</b></td>
                <td>${m.price} ‡∏ö. / ${m.qty} ${m.unit}</td>
                <td style="color:#795548">${avg} / ${m.unit}</td>
                ${isAdmin ? `<td>
                    <button onclick="editMat('${m.id}')" class="btn-edit"><i class="fas fa-edit"></i></button>
                    <button onclick="delMat('${m.id}')" class="btn-del"><i class="fas fa-trash"></i></button>
                </td>` : ''}
            </tr>`;
            sel += `<option value="${m.id}">${m.name} (${avg}/${m.unit})</option>`;
        });
        document.getElementById('matTable').innerHTML = h;
        document.getElementById('selectMat').innerHTML = sel;
    }

    window.saveMaterial = async () => {
        let id=document.getElementById('matId').value, n=document.getElementById('matName').value, p=Number(document.getElementById('matPrice').value), q=Number(document.getElementById('matQty').value), u=document.getElementById('matUnit').value;
        if(n && p && q) {
            let data = { name:n, price:p, qty:q, unit:u };
            if(id) await updateDoc(doc(db, "global_cost_stock", id), data);
            else await addDoc(collection(db, "global_cost_stock"), data);
            document.getElementById('matId').value=''; document.getElementById('matName').value=''; document.getElementById('matPrice').value=''; document.getElementById('matQty').value='';
            fetchMaterials();
        }
    };
    window.editMat = (id) => {
        let m = window.materials.find(x=>x.id==id);
        document.getElementById('matId').value=m.id; document.getElementById('matName').value=m.name; document.getElementById('matPrice').value=m.price; document.getElementById('matQty').value=m.qty; document.getElementById('matUnit').value=m.unit;
    };
    window.delMat = async(id) => { if(confirm('‡∏•‡∏ö‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ô‡∏µ‡πâ?')) { await deleteDoc(doc(db,"global_cost_stock",id)); fetchMaterials(); }};

    // --- RECIPE MIXING ---
    window.addToRecipe = () => {
        let id = document.getElementById('selectMat').value, use = Number(document.getElementById('useQty').value);
        if(id && use) {
            let m = window.materials.find(x=>x.id==id);
            let cost = (m.price/m.qty) * use;
            window.currentRecipe.push({ name:m.name, use:use, unit:m.unit, cost:cost, buyPrice:m.price, buyQty:m.qty });
            renderRecipe(); document.getElementById('useQty').value='';
        }
    };
    function renderRecipe() {
        let h = '', t = 0;
        window.currentRecipe.forEach((r,i) => {
            t += r.cost;
            h += `<tr><td>${r.name}</td><td>${r.use} ${r.unit}</td><td>${r.cost.toFixed(2)}</td><td><button onclick="window.currentRecipe.splice(${i},1);renderRecipe()" class="btn-del">x</button></td></tr>`;
        });
        document.getElementById('recipeTable').innerHTML = h;
        document.getElementById('currentTotal').innerText = t.toFixed(2);
    }

    window.saveRecipe = async () => {
        let n=document.getElementById('recipeName').value, y=document.getElementById('yield').value, t=Number(document.getElementById('currentTotal').innerText);
        if(n && window.currentRecipe.length) {
            await addDoc(collection(db, "saved_recipes"), { name:n, yield:y, items:window.currentRecipe, total:t, date:Timestamp.now() });
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); window.currentRecipe=[]; renderRecipe(); 
            document.getElementById('recipeName').value=''; document.getElementById('yield').value='';
            fetchSavedRecipes(); openCalcTab('saved');
        }
    };

    // --- DETAILED HISTORY MGMT (MATCH IMAGE) ---
    window.fetchSavedRecipes = async () => {
        const q = query(collection(db, "saved_recipes"), orderBy("date", "desc"));
        const snap = await getDocs(q);
        let h = '';
        snap.forEach(d => {
            let r = d.data();
            let date = r.date.toDate().toLocaleString('th-TH', {day:'numeric', month:'numeric', year:'numeric', hour:'2-digit', minute:'2-digit'});
            let itemsHtml = '';
            r.items.forEach(it => {
                itemsHtml += `
                <div class="ing-detail-row">
                    <b>${it.name} ‡πÉ‡∏ä‡πâ ${it.use} ${it.unit} (${it.cost.toFixed(2)} ‡∏ö.)</b>
                    <span class="ing-sub-text">‡∏™‡∏ï‡πá‡∏≠‡∏Å: ‡∏ã‡∏∑‡πâ‡∏≠ ${it.buyPrice} ‡∏ö. / ${it.buyQty} ${it.unit}</span>
                </div>`;
            });

            h += `<tr>
                <td style="color:#666; font-size:0.85em;">${date}</td>
                <td><b>${r.name}</b> <br> <span class="yield-badge">‡∏ó‡∏≥‡πÑ‡∏î‡πâ: ${r.yield || '-'}</span></td>
                <td>${itemsHtml}</td>
                <td>
                    <div class="cost-summary-box">
                        <small style="color:#666;">‡∏ó‡∏∏‡∏ô‡∏£‡∏ß‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</small>
                        <b style="color:var(--green); font-size:1.2em;">${r.total.toFixed(2)}</b>
                        <small style="color:#C62828;">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${(r.total/(r.yield||1)).toFixed(2)}</small>
                    </div>
                </td>
                <td align="center">
                    ${isAdmin ? `
                        <button onclick="editRecipeHistory('${d.id}')" class="btn-edit"><i class="fas fa-edit"></i></button><br>
                        <button onclick="delRecipeHistory('${d.id}')" class="btn-del"><i class="fas fa-trash"></i></button>
                    ` : '-'}
                </td>
            </tr>`;
        });
        document.getElementById('historyDetailedTable').innerHTML = h || '<tr><td colspan="5" align="center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
    };

    window.delRecipeHistory = async (id) => { if(confirm('‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ô‡∏µ‡πâ?')) { await deleteDoc(doc(db,"saved_recipes",id)); fetchSavedRecipes(); }};

    window.editRecipeHistory = async (id) => {
        const snap = await getDoc(doc(db, "saved_recipes", id));
        if(snap.exists()){
            let r = snap.data();
            window.currentRecipe = r.items;
            document.getElementById('recipeName').value = r.name;
            document.getElementById('yield').value = r.yield;
            renderRecipe();
            openCalcTab('calc');
            window.scrollTo(0,0);
        }
    };

    window.openCalcTab = (t) => {
        document.querySelectorAll('.calc-tab').forEach(x=>x.classList.add('hidden'));
        document.querySelectorAll('#cost-view .tab-btn').forEach(x=>x.classList.remove('active'));
        if(t=='calc') document.getElementById('calc-main').classList.remove('hidden');
        if(t=='saved') { document.getElementById('calc-saved').classList.remove('hidden'); fetchSavedRecipes(); }
        event.target.classList.add('active');
    };
</script>
</body>
</html>
